## 一、文件
### 1、基本概念
#### （1）定义
- **文件**：
	- 是以硬盘为载体的存储在计算机上的信息集合，可以是文本文档、图片、程序等
	- 用户进行的输入、输出操作中，以文件为基本单位
- **文件的结构**【自底向上进行定义】：
	- **数据项**：文件系统中最低级的数据组织方式，分为：
		- 基本数据项：描述一个对象的某种属性的一个值，是数据中的最小逻辑单位
		- 组合数据项：由多个基本数据项组成
	- **记录**：一组相关的数据项的集合，用于描述一个对象在某方面的属性
	- **文件**：由创建者所定义的、具有文件名的一组相关元素的集合，分为：
		- 有结构文件：文件由若干个相似的记录组成【如数据库表】
		- 无结构文件：文件被视为一个字节流【如二进制文件或字符文件】

#### （2）属性
- **文件名**：由创建文件的用户决定，为了方便用户找到文件，**同一目录下不允许有重名文件**
- **类型**：被支持不同类型的文件系统所使用
- **创建者**：文件创建者的 ID
- **所有者**：文件当前所有者的 ID
- **位置**：指向设备和设备上文件的指针
- **大小**：文件当前大小（用字节、字或块表示），也可包含文件允许的最大值
- **保护**：对文件进行保护的访问控制信息
- **创建时间、最后一次修改时间、最后一次存取时间**：用于保护和跟踪文件

### 2、文件的数据结构
#### （1）文件控制块 FCB
- **文件控制块**：用来存放控制文件需要的各种信息的数据结构，以实现**按名存取**
- **文件目录**：FCB 的有序集合【文件与 FCB 一一对应，一个 FCB 就是一个**文件目录项**】
- **目录文件**：一个文件目录也被视为一个文件
- 每当创建一个新文件，系统就要为其建立一个 FCB，用来记录文件的各种属性
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240519145726.png)
- FCB 主要包含以下信息：
	- **基本信息**：文件名、文件的物理位置、文件的逻辑结构、文件的物理结构
	- **存取控制信息**：文件主的存取权限、核准用户的存取权限以及一般用户的存取权限
	- **使用信息**：文件的建立时间、上次修改时间等

#### （2）索引节点
- **索引节点**：包含了**除文件名之外**的所有信息，每个文件对应一个索引节点
- 文件目录的目录项中仅由**文件名**和相应的**索引节点号**（或索引节点指针）构成
- **优点**：使用索引节点，目录项长度减小，因此每个磁盘块可以存放更多个目录项，减少了索引文件时磁盘 I/O 的次数
- **分类**：
	- **磁盘索引节点**：
		- 指存放在磁盘上的索引节点【**外存中**】
		- 每个文件有一个唯一的磁盘索引节点
		- 包含：文件主标识符、文件类型、文件存取权限、文件物理地址、文件长度、文件链接计数、文件存取时间
	- **内存索引节点**：
		- 指存放在**内存中**的索引节点
		- 文件被打开时，将磁盘索引节点复制到内存的索引节点，便于以后使用
		- 新增：索引节点号、状态、访问计数、逻辑设备号、链接指针

### 3、文件的操作

#### （1）创建文件（create 系统调用）
- 需要提供的**主要参数**：
	- 所需的外存空间大小（如：一个盘块，即 1 KB）
	- 文件存放路径（“D:/Demo”）
	- 文件名（这个地方默认为“新建文本文档.txt”）
- OS 的**处理过程**：
	- **在外存中找到文件所需的空间**
	- 根据文件存放路径的信息找到该目录对应的目录文件（此处就是 D:/Demo 目录），在目录中**创建该文件对应的目录项**

#### （2）删除文件（delete 系统调用）
- 需要提供的**主要参数**：
	- 文件存放路径（“D:/Demo”）
	- 文件名（“test.txt”）
- OS 的**处理过程**：
	- 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的目录项**
	- 根据该目录项记录的文件在外存的存放位置、文件大小等信息，**回收文件占用的磁盘块**
	- 从目录表中**删除文件对应的目录项**

#### （3）打开文件（open 系统调用）
- 需要提供的**主要参数**：
	- 文件存放路径（“D:/Demo”）
	- 文件名（“test. Txt”）
	- 要对文件的操作类型（如：r 只读；rw 读写等）
- OS 的**处理过程**：
	- 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的的目录项**，并检查该用户是否有指定的操作权限
	- **将目录项从外存复制到内存中的“打开文件表”** 的一个表目中，并将该表目的索引号（也称**文件描述符**）返回给用户
- **注意**：
	- 只要完成了 open 系统调用，之后对文件的操作（read，write，Lseek，close 等）均**使用文件描述符**，这样可以加快文件的访问速度
	- **打开文件表整个系统只有一张**
	- 对于访问打开文件表的索引号，UNIX 称之为文件描述符，Windows 称之为文件句柄
- **打开文件所具有的关联信息**：
	- **文件指针**：
		- 系统跟踪**上次的读写位置**作为当前文件位置的指针
		- 这种指针**对打开文件的某个进程来说是唯一的**，因此必须与磁盘文件属性分开保存
	- **文件打开计数**：
		- 计数器跟踪**当前文件打开和关闭的数量**
		- 因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件
	- **文件磁盘位置**：
		- 大多数文件操作要求系统修改文件数据
		- **查找磁盘上的文件所需的信息保存在内存中**，以便系统不必为每个操作都从磁盘上读取该信息
	- **访问权限**：
		- 每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等）
		- 该信息保存在进程的打开文件表中，以便操作系统能够允许或拒绝后续的 I/O 请求

#### （4）关闭文件（close 系统调用）
- OS 的**处理过程**：
	- 将进程的打开文件表相应表项删除
	- 回收分配给该文件的内存空间等资源
	- 系统打开文件表的打开计数器 count 减 1，若 count =0，则删除对应表项
- 内存中**文件的系统结构**：
	- 在多个不同进程可以同时打开文件的操作系统中，通常采用**两级表**：
		- **整个系统的打开文件表**：包含与进程无关的信息，如文件在磁盘上的位置、访问日期和文件大小
		- **每个进程的打开文件表**：保存的是进程对文件的使用信息，如文件的当前读写指针、文件访问权限，并包含指向系统表中适应条目的指针
	- 一旦有进程打开了一个文件，系统表就包含该文件的条目
	- 当另一个进程执行调用 open 时，只不过是在其文件打开表中增加一个条目，并指向系统表的相应条目
	- 通常，系统打开文件表为每个文件关联一个**打开计数器**（Open Count）, 以记录多少进程打开了该文件
	- 每个关闭操作 close 使 count 递减，当打开计数器为 0 时，表示该文件不再被使用，并且可从系统打开文件表中删除相应条目
	![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240519155554.png)

#### （5）读文件（read 系统调用）
- 根据文件名查找目录【open 之后通过文件描述符】，找到指定文件的目录项后，再利用目录项中的读指针进行读操作
- 从读指针指向的外存中，将用户指定大小的数据读入用户指定的内存区域
- **外存 ---> 内存**

#### （6）写文件（write 系统调用）
- 根据文件名查找目录【open 之后通过文件描述符】，找到指定文件的目录项后，再利用目录项中的写指针进行写操作
- 从用户指定的内存区域中，将指定大小的数据写回写指针指向的外存
- **内存 ---> 外存**

### 4、文件保护

#### （1）基本概念
- **保护的目的**：解决对文件的读、写、执行的许可问题
- 一个文件的访问常由**用户访问权限和文件属性**（包括保存在 FCB 中对文件访问的控制信息）共同设置

#### （2）非访问控制方法
- 都是防止用户文件被他人存取或窃取，并没有控制用户对文件的访问类型
##### 1）口令保护
- **定义**：用户建立一个文件时需要提供口令【附在 FCB 上】，用户请求访问时必须提供相应口令
- **优点**：时间和空间开销不多
- **缺点**：口令直接存在系统内部，不安全

##### 2）加密保护
- **定义**：对文件进行加密，被访问时需要使用秘钥
- **优点**：保密性强，节省了存储空间
- **缺点**：编码和译码需要时间

#### （3）访问控制方法
- **访问类型**：读、写、执行、添加、删除、列表清单
- **方法**：
	- 根据**用户身份**进行访问控制
	- 为每个文件和目录增加一个**访问控制表 ACL**，以规定每个用户名及其所允许的访问类型
	- **优点**：可以使用复杂的访问方法
	- **缺点**：长度无法预计并且可能导致复杂的空间管理
- **注意**：
	- 上述的文件保护可以只在低层提供
	- 对文件的**重命名、复制、粘贴**等控制方式【高层功能】，可通过系统程序调用低层系统调用实现
- **精简的访问控制列表**：
	- 解决 ACL 的问题，包含三种用户类型：
		- **拥有者**：创建文件的用户
		- **组**：一组需要共享文件且具有类似访问的用户
		- **其他**：系统内的所有其他用户
	![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240519163103.png)
	- **每项占用一个二进制位**，只需 3 * 4 位的矩阵即可描述三类用户的权限
	- 创建文件时，系统将文件拥有者的名字、所属组名记录在该文件的 FCB 中

### 4、文件的逻辑结构
- 指从**用户角度**出发所看到的文件的组织形式
#### （1）无结构文件
- **基本概念**：
	- 最简单的文件组织形式
	- 文件内部的数据就是一系列**二进制流或字符流**，又称**流式文件**
	- 其长度**以字节为单位**
	- 如：系统中运行的大量源程序、可执行文件、库函数等
- **访问方式**：
	- 通过**读/写指针**来指出下一个要访问的字节
	- 没有结构，因此**对记录的访问**只能通过**穷举搜索**的方式

#### （2）有结构文件
- **基本概念**：
	- 指由一个以上的记录构成的文件，又称**记录式文件**
	- 各记录由相同或不相同的数据项组成
- 根据各记录的**长度是否相等**，可分为：
	- **定长记录**：
		- 文件中所有记录的长度相同
		- 各数据项都在记录中的相同位置，具有相同的长度
		- **特点**：检索记录的速度快，方便用户对文件进行处理，广泛用于数据处理中
	- **变长记录**：
		- 文件中各记录的长度不一定相同
		- 记录中所包含的数据项数目可能不同，数据项本身的长度可能不同
		- **特点**：检索记录只能顺序查找，速度慢

- 根据记录的**组织形式**，可分为：
##### 1）顺序文件
- 文件中的记录一个接一个地顺序排列（逻辑上），记录可以是**定长**的或**可变长**的
- 各个记录在**物理上**有两种存储方式：
	- **顺序存储**：
		- 逻辑上相邻的记录物理上也相邻
		- **可变长记录**：**无法实现随机存取**，每次只能从第一个记录开始依次往后查找
		- **定长记录**：
			- **可以实现随机存取**
			- 若采用串结构，无法快速找到某关键字对应的记录
			- 若采用顺序结构，可以快速找到某关键字对应的记录（如折半查找）
	- **链式存储**：
		- 逻辑上相邻的记录物理上不一定相邻（类似于链表）
		- 无论是定长/可变长记录，都无法实现随机存取
- 顺序文件中记录的排列有两种结构：
	- **串结构**：各记录之间的顺序与关键字无关
	- **顺序结构**：记录之间的顺序按关键字顺序排列
- **注意**：
	- 对记录进行**批量操作**，即每次要读或写一大批记录时，顺序文件的**效率**是所有逻辑文件中**最高**的
	- 对于顺序存储设备（如磁盘），只有顺序文件才能被存储并能有效地工作
	- 在需要经常增删改查单个记录的场合，性能较差

##### 2）索引文件
- 建立一张**索引表**，为主文件的**每个记录**在索引表中分别**设置一个索引表项**，其中包含**指向记录的指针**和**记录长度**
- 索引表按关键字排序，其本身也**是一个定长记录的顺序文件**
- 将**对变长记录顺序文件**的检索转变成对记录索引文件的随机检索，从而**加快了记录的检索速度**
- 主要用于对信息处理的及时性要求比较高的场合
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525155737.png)

##### 3）索引顺序文件
- 是索引文件和顺序文件思想的结合
- 先将变长记录顺序文件中的所有记录分为若干组，然后为文件建立一张索引表
- 为**每组中的第一个记录建立一个索引项**，包含该记录的**关键字**和**指向该记录的指针**
- 同一组内的关键字可以无序，组与组之间的关键字必须有序
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525160520.png)
- 检索效率分析：
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525160652.png)

##### 4）直接文件或散列文件（Hash File）
- 给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址
- 这种映射结构不同于顺序文件或索引文件，**没有顺序的特性**
- 散列文件有很高的存取速度，但是会引起冲突，即不同关键字的散列函数值相同

### 5、文件的物理结构
- 用户通过逻辑地址来操作自己的文件，操作系统如何实现从逻辑地址到物理地址的映射？
- （逻辑块号，块内地址）--->（物理块号，块内地址）【只需转换块号就行，块内地址保
持不变】

#### （1）连续分配
- 要求**每个文件在磁盘上占有一组连续的块**
- 磁盘地址定义了磁盘上的一个线性排序，使作业访问磁盘时需要的寻道数和寻到时间最小
- **优点**：
	- 支持顺序访问和直接访问（即随机访问）
	- 连续分配的文件在顺序访问时速度最快
- **缺点**：
	- 文件长度不宜动态增加
	- 存储空间利用率低，反复增删文件后会产生外部碎片
	- 很难确定一个文件需要的空间大小，因此只适用于长度固定的文件
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525170229.png)

#### （2）链接分配
##### 1）隐式链接
- 目录中记录了文件存放的**起始块号**和**结束块号**
- 每个文件对应一个磁盘块的链表，磁盘块分布在磁盘的任何地方
- 除最后一个盘块外，每个盘块都含有指向文件下一个盘块的指针，这些**指针对用户是透明的**
- **优点**：
	- 方便文件拓展，不会有碎片问题，外存利用率高
- **缺点**：
	- 只适合顺序访问，不支持随机访问，查找效率低
	- 稳定性问题，文件盘块中的任何一个指针出问题，都会导致文件数据的丢失
	- 指向下一个盘块的指针也要耗费一定的存储空间
- 为了提高查找速度和减小指针所占空间，可以将几个盘块组成一个簇，按簇分配，可以大幅减少查找时间，但增加了内部碎片
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525170710.png)

##### 2）显式链接
- 指把用于链接文件各物理块的指针，从每个物理块的末尾中提取出来，显式地存放在内存的一张链接表
- 该表在**整个磁盘中仅设置一张**，称为**文件分配表 FAT**
- 开机时文件分配表放入内存，并**常驻内存**
- 文件目录中只需记录**文件的起始块号**，后续块号可通过查 FAT
- **优点**：
	- 很方便文件拓展，不会有碎片问题，外存利用率高，并且支持随机访问
	- 相比于隐式链接来说，**地址转换时不需要访问磁盘，因此文件的访问效率更高**
- **缺点**：
	- 文件分配表的需要占用一定的存储空间
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525171646.png)

#### （3）索引分配

##### 1）单级索引分配
- 将每个文件所有的盘块号集中地放在一起，当访问到某个文件时，将该文件对应的盘块号一起调入内存
- 为**每个文件分配一个索引块（表）**，存放分配给**该文件的所有盘块号**
- 假如盘块大小为 4 KB，每个盘块号占 4 B，则一个索引块中可放 1024 个盘块号，支持最大文件为 1024 * 4 KB = 4 MB
- **优点**：
	- 支持直接访问
	- 不会产生外部碎片
- **缺点**：
	- 索引块增加了额外的存储空间开销
	- 当文件很小时，比如只有数个盘块，此时索引块的利用率很低
	- 当文件很大时，若其盘块号占用若干索引块，可通过链指针将各索引块按序链接起来，但是很查找效率低下
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525173851.png)

##### 2）多级索引分配
- 文件太大而索引块太多时，为这些索引块再建立一级索引，称为**主索引**
- 采用 K 层索引结构，且顶级索引表未调入内存，则访问一个数据块需要 K+1 次读磁盘操作
- 假如盘块大小为 4 KB，每个盘块号占 4 B，则一个索引块中可放 1024 个盘块号，支持最大文件为 1024 * 1024 * 4 KB = 4 GB
- **优点**：极大加快了对大型文件的查找速度
- **缺点**：当访问一个盘块时，其所要启动磁盘的次数随着索引级数的增加而增多
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525174427.png)

##### 3）混合索引分配
- 全面照顾到小型、中星、大型和特大型文件
- **直接地址**：
	- 地址项 0~9 存放直接地址，即文件数据块的盘块号
	- 假如每个盘块大小为 4 KB，适用于不大于 40 KB 的文件
	- 提高了对小文件的检索速度
- **一次间接地址**：
	- 地址项 10 提供，即采用一级索引分配
	- 一次间接地址中记录了文件的一次间址块号，一次间址块就是索引块，记录了文件数据块的盘块号
	- 一次间址块中可存放 1024 个盘块号，允许最大文件长度 4 MB + 40 KB
- **多次间接地址**：
	- 地址项 11 提供二次间接地址，即采用两级索引分配
	- 允许最大文件长度 4 GB + 4 MB + 40 KB
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240525175037.png)


## 二、目录



## 三、文件系统

