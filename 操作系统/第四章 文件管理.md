## 一、文件
### 1、基本概念
#### （1）定义
- **文件**：
	- 是以硬盘为载体的存储在计算机上的信息集合，可以是文本文档、图片、程序等
	- 用户进行的输入、输出操作中，以文件为基本单位
- **文件的结构**【自底向上进行定义】：
	- **数据项**：文件系统中最低级的数据组织方式，分为：
		- 基本数据项：描述一个对象的某种属性的一个值，是数据中的最小逻辑单位
		- 组合数据项：由多个基本数据项组成
	- **记录**：一组相关的数据项的集合，用于描述一个对象在某方面的属性
	- **文件**：由创建者所定义的、具有文件名的一组相关元素的集合，分为：
		- 有结构文件：文件由若干个相似的记录组成【如数据库表】
		- 无结构文件：文件被视为一个字节流【如二进制文件或字符文件】

#### （2）属性
- **文件名**：由创建文件的用户决定，为了方便用户找到文件，**同一目录下不允许有重名文件**
- **类型**：被支持不同类型的文件系统所使用
- **创建者**：文件创建者的 ID
- **所有者**：文件当前所有者的 ID
- **位置**：指向设备和设备上文件的指针
- **大小**：文件当前大小（用字节、字或块表示），也可包含文件允许的最大值
- **保护**：对文件进行保护的访问控制信息
- **创建时间、最后一次修改时间、最后一次存取时间**：用于保护和跟踪文件

### 2、文件的数据结构
#### （1）文件控制块 FCB
- **文件控制块**：用来存放控制文件需要的各种信息的数据结构，以实现**按名存取**
- **文件目录**：FCB 的有序集合【文件与 FCB 一一对应，一个 FCB 就是一个**文件目录项**】
- **目录文件**：一个文件目录也被视为一个文件
- 每当创建一个新文件，系统就要为其建立一个 FCB，用来记录文件的各种属性
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240519145726.png)
- FCB 主要包含以下信息：
	- **基本信息**：文件名、文件的物理位置、文件的逻辑结构、文件的物理结构
	- **存取控制信息**：文件主的存取权限、核准用户的存取权限以及一般用户的存取权限
	- **使用信息**：文件的建立时间、上次修改时间等

#### （2）索引节点
- **索引节点**：包含了**除文件名之外**的所有信息，每个文件对应一个索引节点
- 文件目录的目录项中仅由**文件名**和相应的**索引节点号**（或索引节点指针）构成
- **优点**：使用索引节点，目录项长度减小，因此每个磁盘块可以存放更多个目录项，减少了索引文件时磁盘 I/O 的次数
- **分类**：
	- **磁盘索引节点**：
		- 指存放在磁盘上的索引节点【**外存中**】
		- 每个文件有一个唯一的磁盘索引节点
		- 包含：文件主标识符、文件类型、文件存取权限、文件物理地址、文件长度、文件链接计数、文件存取时间
	- **内存索引节点**：
		- 指存放在**内存中**的索引节点
		- 文件被打开时，将磁盘索引节点复制到内存的索引节点，便于以后使用
		- 新增：索引节点号、状态、访问计数、逻辑设备号、链接指针

### 3、文件的操作

#### （1）创建文件（create 系统调用）
- 需要提供的**主要参数**：
	- 所需的外存空间大小（如：一个盘块，即 1 KB）
	- 文件存放路径（“D:/Demo”）
	- 文件名（这个地方默认为“新建文本文档.txt”）
- OS 的**处理过程**：
	- **在外存中找到文件所需的空间**
	- 根据文件存放路径的信息找到该目录对应的目录文件（此处就是 D:/Demo 目录），在目录中**创建该文件对应的目录项**

#### （2）删除文件（delete 系统调用）
- 需要提供的**主要参数**：
	- 文件存放路径（“D:/Demo”）
	- 文件名（“test.txt”）
- OS 的**处理过程**：
	- 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的目录项**
	- 根据该目录项记录的文件在外存的存放位置、文件大小等信息，**回收文件占用的磁盘块**
	- 从目录表中**删除文件对应的目录项**

#### （3）打开文件（open 系统调用）
- 需要提供的**主要参数**：
	- 文件存放路径（“D:/Demo”）
	- 文件名（“test. Txt”）
	- 要对文件的操作类型（如：r 只读；rw 读写等）
- OS 的**处理过程**：
	- 根据文件存放路径找到相应的目录文件，从目录中**找到文件名对应的的目录项**，并检查该用户是否有指定的操作权限
	- **将目录项从外存复制到内存中的“打开文件表”** 的一个表目中，并将该表目的索引号（也称**文件描述符**）返回给用户
- **注意**：
	- 只要完成了 open 系统调用，之后对文件的操作（read，write，Lseek，close 等）均**使用文件描述符**，这样可以加快文件的访问速度
	- **打开文件表整个系统只有一张**
	- 对于访问打开文件表的索引号，UNIX 称之为文件描述符，Windows 称之为文件句柄
- **打开文件所具有的关联信息**：
	- **文件指针**：
		- 系统跟踪**上次的读写位置**作为当前文件位置的指针
		- 这种指针**对打开文件的某个进程来说是唯一的**，因此必须与磁盘文件属性分开保存
	- **文件打开计数**：
		- 计数器跟踪**当前文件打开和关闭的数量**
		- 因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件
	- **文件磁盘位置**：
		- 大多数文件操作要求系统修改文件数据
		- **查找磁盘上的文件所需的信息保存在内存中**，以便系统不必为每个操作都从磁盘上读取该信息
	- **访问权限**：
		- 每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等）
		- 该信息保存在进程的打开文件表中，以便操作系统能够允许或拒绝后续的 I/O 请求

#### （4）关闭文件（close 系统调用）
- OS 的**处理过程**：
	- 将进程的打开文件表相应表项删除
	- 回收分配给该文件的内存空间等资源
	- 系统打开文件表的打开计数器 count 减 1，若 count =0，则删除对应表项
- 内存中**文件的系统结构**：
	- 在多个不同进程可以同时打开文件的操作系统中，通常采用**两级表**：
		- **整个系统的打开文件表**：包含与进程无关的信息，如文件在磁盘上的位置、访问日期和文件大小
		- **每个进程的打开文件表**：保存的是进程对文件的使用信息，如文件的当前读写指针、文件访问权限，并包含指向系统表中适应条目的指针
	- 一旦有进程打开了一个文件，系统表就包含该文件的条目
	- 当另一个进程执行调用 open 时，只不过是在其文件打开表中增加一个条目，并指向系统表的相应条目
	- 通常，系统打开文件表为每个文件关联一个**打开计数器**（Open Count）, 以记录多少进程打开了该文件
	- 每个关闭操作 close 使 count 递减，当打开计数器为 0 时，表示该文件不再被使用，并且可从系统打开文件表中删除相应条目
	![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240519155554.png)

#### （5）读文件（read 系统调用）
- 根据文件名查找目录【open 之后通过文件描述符】，找到指定文件的目录项后，再利用目录项中的读指针进行读操作
- 从读指针指向的外存中，将用户指定大小的数据读入用户指定的内存区域
- **外存 ---> 内存**

#### （6）写文件（write 系统调用）
- 根据文件名查找目录【open 之后通过文件描述符】，找到指定文件的目录项后，再利用目录项中的写指针进行写操作
- 从用户指定的内存区域中，将指定大小的数据写回写指针指向的外存
- **内存 ---> 外存**

### 4、文件保护

#### （1）基本概念
- **保护的目的**：解决对文件的读、写、执行的许可问题
- 一个文件的访问常由**用户访问权限和文件属性**（包括保存在 FCB 中对文件访问的控制信息）共同设置

#### （2）非访问控制方法
- 都是防止用户文件被他人存取或窃取，并没有控制用户对文件的访问类型
##### 1）口令保护
- **定义**：用户建立一个文件时需要提供口令【附在 FCB 上】，用户请求访问时必须提供相应口令
- **优点**：时间和空间开销不多
- **缺点**：口令直接存在系统内部，不安全

##### 2）加密保护
- **定义**：对文件进行加密，被访问时需要使用秘钥
- **优点**：保密性强，节省了存储空间
- **缺点**：编码和译码需要时间

#### （3）访问控制方法
- **访问类型**：读、写、执行、添加、删除、列表清单
- **方法**：
	- 根据**用户身份**进行访问控制
	- 为每个文件和目录增加一个**访问控制表 ACL**，以规定每个用户名及其所允许的访问类型
	- **优点**：可以使用复杂的访问方法
	- **缺点**：长度无法预计并且可能导致复杂的空间管理
- **注意**：
	- 上述的文件保护可以只在低层提供
	- 对文件的**重命名、复制、粘贴**等控制方式【高层功能】，可通过系统程序调用低层系统调用实现
- **精简的访问控制列表**：
	- 解决 ACL 的问题，包含三种用户类型：
		- **拥有者**：创建文件的用户
		- **组**：一组需要共享文件且具有类似访问的用户
		- **其他**：系统内的所有其他用户
	![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240519163103.png)
	- **每项占用一个二进制位**，只需 3 * 4 位的矩阵即可描述三类用户的权限
	- 创建文件时，系统将文件拥有者的名字、所属组名记录在该文件的 FCB 中

## 二、目录



## 三、文件系统

