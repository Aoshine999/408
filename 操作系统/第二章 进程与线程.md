## 一、进程与线程
### 1、进程的概念与特征
#### （1）进程的定义
- 进程是程序的一次执行过程
- 进程是一个程序及其数据在处理机上顺序执行时所发生的活动
- 进程是具有独立功能的程序在一个数据集合上运行的过程
- 进程是进程实体的运行过程，是系统进行**资源分配和调度的一个独立单位**
- **为什么引入进程**：
	- 为了使多道程序并发执行，提高资源利用率和系统吞吐量
	- 为了可以对并发执行的程序加以描述和控制，实现操作系统的并发性和共享性

#### （2）进程的特征
- **动态性**：进程是程序的一次执行过程，是动态地产生、变化和消亡的【最基本的特征】
- **并发性**：内存中有多个进程实体，各进程可并发执行
- **独立性**：进程是能独立运行、获得资源、独立接受调度的基本单位
- **异步性**：各进程按各自独立的、不可预知的速度向前推进【操作系统要提供“进程同步机制”来解决异步问题】

#### （3）进程与程序的区别
- 进程：是**动态的**，是程序的一次执行过程【如：可同时启动多次 QQ】
- 程序：是**静态的**，就是存放在磁盘里的可执行文件【如：QQ.exe】
- 同一个程序多次执行会对应多个进程

#### （4）进程的组成
- 一个**进程实体**（进程映像）由 **PCB、程序段、数据段**组成
- 进程是动态的，进程实体是**静态的**
- 进程实体反映了进程在某一时刻的状态
##### 1）进程控制块（PCB）
- **定义**：
	- PCB 是进程实体的一部分，是进程存在的唯一标志
	- 进程创建时，操作系统为它新建一个 PCB，该结构常驻内存
- **包含**：
	1. **进程描述信息**：
		- 进程标识符 PID：标识各个进程，每个进程都有一个并且唯一的标识号
		- 用户标识符 UID：进程归属的用户，用户标识符主要为共享和保护服务
	2. **进程控制和管理信息**：
		- 进程当前状态：描述进程状态信息，作为 CPU 调度的依据
		- 进程优先级：描述进程抢占 CPU 的优先级
		- 代码运行入口地址
		- 程序的外存地址
		- 进入内存时间
		- CPU 占用时间
		- 信号量使用
	3. **资源分配清单**：
		- 有关内存地址空间和虚拟地址空间的状况
		- 所打开文件的列表和所使用的输入/输出设备信息
	4. **处理机相关信息**【CPU 的上下文】：
		- CPU 中各寄存器的值
		- 当进程被切换时，CPU 的状态信息都会被保存在相应的 PCB 中以便进程重新执行时，能从断点处继续执行
- **组织方式**：
	- 链接方式：
		- 把同一状态的 PCB 链成一个队列，不同状态对应不同的队列
		- 也可把处于阻塞态的进程的 PCB，根据阻塞原因，排成多个阻塞队列
	- 索引方式：
		- 将同一状态的进程组织在一个索引表中，索引表的表项指向相应的 PCB
		- 如就绪索引表，阻塞索引表

##### 2）程序段
- 能被进程调度程序调度到 CPU 执行的程序代码段
- 程序可以被多个进程共享，即多个进程可以运行同一个程序

##### 3）数据段
- 可以是进程对应的程序加工处理的原始数据
- 可以是程序执行时产生的中间或最终结果

### 2、进程的状态与转换
#### （1）五种状态
- **运行态** Running：该时刻进程占用 CPU
- **就绪态** Ready：进程获得了**除处理机外的一切所需资源**，一旦得到处理机，就可以立即运行
- **阻塞态** Blocked：该进程正在等待某一事件发生而暂停运行，如等待某个资源可用（不包括 CPU）或等待 I/O 完成
- **创建态** New：进程正在被创建时的状态
- **结束态** Exit：进程正在从系统中消失时的状态

#### （2）状态转换
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240509150939.png)
- **就绪态 ---> 运行态**：
	- 进程被调度，获得处理机资源（分派处理机时间片）
- **运行态 ---> 就绪态**：
	- 时间片用完后，不得不让出处理机
	- 可剥夺的 OS 中，当有**更高优先级的进程就绪**时，调度程序将正在执行的进程转换为就绪态
- **运行态 ---> 阻塞态**：
	- 该过程是**主动行为**
	- 进程请求某一资源（如外设） 的使用和分配时
	- 等待某一事件的发送时（如 I/O 操作的完成）
	- 进程以**系统调用**的方式请求 OS 提供服务，这个过程系统从用户态转换为核心态
- **阻塞态 ---> 就绪态**：
	- 该过程是**被动行为**，需要其他相关进程的协助
	- I/O 操作结束或中断结束时
	- 发送了阻塞队列等待的事件，如发送了 V 操作，信号量+1，然后阻塞队列被唤醒到就绪队列中

### 3、进程控制
- **进程控制**：主要功能是对系统中的所有进程实施有效的管理，具有创建新进程、撤销已有进程、实现进程状态转换等功能
- **原语**：进程控制用的程序段【执行期间不允许中断，是一个不可分割的基本单位】
	- 可以用 “关中断指令”和“开中断指令”这两个特权指令实现原子性

![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240509155911.png)

#### （1）进程的创建
##### 1）定义及过程
- 允许一个进程创建另一个进程
- 允许子进程继承父进程所拥有的资源
- **创建原语**：
	- 为新进程分配一个进程标识号，申请一个空白的 PCB【PCB 是有限的】
	- 为该进程分配运行时所必需的资源，如内存、文件、I/O 和 CPU 时间等
	- 初始化 PCB，如标志、状态、控制、优先级信息
	- 将 PCB 插入就绪队列

##### 2）对应事件
- **用户登录**：分时系统中，用户登录成功，系统会为其建立一个新的进程
- **作业调度**：多道批处理系统中，有新的作业放入内存时，会为其建立一个新的进程
- **系统提供服务**：用户向操作系统提出某些请求时，会建立一个进程处理该请求
- **用户程序的应用**：由用户进程主动请求创建一个子进程
- **注意**：设备分配不需要创建进程

#### （2）进程的终止
##### 1）定义及过程
- 当子进程被终止时，其在父进程处继承的资源应当还给父进程
- 当父进程被终止时，该父进程的子进程就变为孤儿进程
-  **终止原语**：
	- 查找需要终止的进程的 PCB
	- 如果处于执行状态，则立即终止该进程的执行，然后将 CPU 资源分配给其他进程
	- 如果其还有子进程，全部终止
	- 将该进程所拥有的全部资源都归还给操作系统
	- 将其从 PCB 所在队列中删除

##### 2）对应事件
- **正常结束**：进程任务完成并自己准备退出运行
- **异常结束**：进程运行时发生了异常事件
- **外界干预**：如操作系统干预、父进程请求或父进程终止

#### （3）进程的阻塞
##### 1）定义及过程
- 当进程需要等待某一事件完成时，它可以调用阻塞语句把自己阻塞等待
- 一旦被阻塞等待，只能由另一个进程唤醒
- **阻塞原语**：
	- 找到将要被阻塞进程标识号对应的 PCB
	- 如果该进程为运行状态，则保护其现场，将其状态转为阻塞状态，停止运行
	- 将该 PCB 插入到阻塞队列中去

##### 2）对应事件
- 需要等待系统系统分配某种资源
- 需要等待相互合作的其他进程完成工作

#### （4）进程的唤醒
##### 1）定义及过程
- 进程由「运行」转变为「阻塞」状态是由于进程必须等待某一事件的完成
- 处于阻塞状态的进程是绝对不可能叫醒自己
- 如果某进程正在等待 I/O 事件，需由别的进程发消息给它
- 只有当该进程所期待的事件出现时，才由发现者进程用唤醒语句叫醒它
- **唤醒原语**：
	- 在该事件的阻塞队列中找到相应进程的 PCB
	- 将其从阻塞队列中移出，并置其状态为就绪状态
	- 把该 PCB 插入到就绪队列中，等待调度程序调度
- **注意**：阻塞原语和唤醒原语必须成对使用

##### 2）对应事件
- 等待的事件发生

#### （5）进程的切换
##### 1）定义及过程
- 进程状态之间的转换
- **切换原语**：
	- 将运行环境信息（进程上下文）存入 PCB
	- PCB 移入相应队列
	- 选择另一个进程执行，并更新其 PCB
	- 根据 PCB 恢复新进程所需的运行环境

##### 2）对应事件
- 当前进程时间片到
- 由更高优先级的进程到达
- 当前进程主动阻塞
- 当前进程终止

### 4、进程通信
- **进程通信**：指进程之间的信息交换
- 各进程拥有的内存地址空间相互独立
- 为了保证安全，一个进程不能直接访问另一个进程的地址空间
#### （1）低级通信方式
- PV 操作
#### （2）高级通信方式
##### 1）共享存储
- 设置一个共享内存区域，并映射到进程的虚拟地址空间
- 要**互斥地访问**共享空间【通信进程自己负责实现】
- **基于数据结构的共享**：
	- 比如共享空间里只能放一个长度为 10 的数组
	- 速度慢、限制多
	- 是一种低级通信方式
- **基于存储区的共享**：
	- 操作系统在内存中划出一块共享存储区，数据的形式、存放位置都由通信进程控制，而不是操作系统
	- 灵活性高、速度快
	- 是一种高级通信方式

##### 2）信息传递
- 进程间的数据交换以**格式化的消息**（Message）为单位
- 进程通过操作系统提供的“**发送消息/接收消息”两个原语**进行数据交换
- 隐藏了通信实现细节，对用户透明，简化了通信程序的设计
- 应用最广泛
- **直接通信方式**：发送进程直接将消息发送给接收进程，并将它挂在接收进程的消息缓冲队列上，接收进程从队列取得消息
- **间接通信方式**：发送进程将消息发送给某个中间实体【信箱】

##### 3）管道通信
- 管道只能采用**半双工通信**，某一时间段内只能实现单向的传输【如果要实现**双向同时通信**，则需要设置**两个管道**】
- 各进程要**互斥**地访问管道【由操作系统实现】
- 当**管道写满**时，**写进程将阻塞**，直到读进程将管道中的数据取走，即可唤醒写进程
- 当**管道读空**时，**读进程将阻塞**，直到写进程往管道中写入数据，即可唤醒读进程
- 管道中的数据一旦被读出，就彻底消失。因此，当多个进程读同一个管道时，可能会错乱，解决方案：
	1. 一个管道允许多个写进程，一个读进程
	2. 允许有多个写进程，多个读进程，但系统会让各个读进程轮流从管道中读数据（Linux 的方案）
- 管道是一种**特殊文件**，可以克服使用文件通信的两个问题：
	1. 限制管道的大小：管道文件是一个固定文件大小的缓冲区
	2. 读进程也可能工作得比写进程快
- 管道只能由创建进程访问【子进程可继承父进程的管道，并可用它来与父进程通信】
- 从管道读数据是**一次性操作**，数据一旦被读取，就释放空间以便写更多数据


## 二、CPU 调度


## 三、同步与互斥


## 四、死锁