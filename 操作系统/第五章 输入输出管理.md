## 一、I/O 管理概述
### 1、I/O 设备
#### （1）设备的分类
##### 1）按信息交换的单位
- **块设备**：
	- 信息交换以数据块为单位，如磁盘、磁带
	- 基本特征：传输速率较高、可寻址，即对它可随意地读/写任意一块
	- 属于有结构设备
- **字符设备**：
	- 信息交换以字符为单位，如交互式终端机、打印机
	- 基本特征：传输速率低、不可寻址，常采用中断 I/O 方式
	- 属于无结构设备

##### 2）按设备的传输速率
- **低速设备**：键盘、鼠标
- **中速设备**：激光打印机
- **高速设备**：磁盘机、光盘机

##### 3）按设备的共享属性
- **独占设备**：
	- 一个时刻只能由一个进程占用
	- 所有字符设备都是独占设备
	- 速度慢，利用率低
	- 如输入机、打印机、磁带机
- **共享设备**：
	- 同一时间段内允许多个进程同时访问的设备
	- 共享设备必须是可寻址和可随机访问的设备
	- 如软硬盘、磁盘、光盘
- **虚拟设备**：
	- 通过 SPOOLing 技术将独占设备改造为共享设备
	- 将一个物理设备变为多个逻辑设备，从而可将设备同时分配给多个进程
	- 实质上还是独占设备

##### 4）按设备的使用特性
- **存储设备**：
	- 存储信息的外部设备
	- 如磁盘、磁带、光盘
- **输入/输出设备**：
	- 输入设备：向计算机输入外部信息，如键盘、鼠标、扫描仪
	- 输出设备：计算机向外输出数据信息，如打印机
	- 交互式设备：集成两种功能，如触控显示器

#### （2）设备控制器（I/O 接口）
##### 1）主要功能
- 接受和识别 CPU 发出的命令
- 向 CPU 报告设备的状态
- 数据交换
- 地址识别
- 数据缓冲
- 差错控制

##### 2）组成
- **设备控制器与 CPU 的接口**：
	- 用于实现 CPU 与控制器之间的通信，有三类信号线
	- 数据线：传送的是读/写数据、控制信息和状态信息
	- 地址线：传送的是要访问 I/O 接口中的寄存器编号
	- 控制线：传送的是读/写等控制信号
- **设备控制器与设备的接口**：
	- 用于实现控制器和设备之间的通信
	- 控制器中有一个或多个设备接口
	- 每个接口都可传输数据、控制和状态三种类型的信号
- **I/O 逻辑**：
	- 用于实现对设备的控制
	- 通过一组控制线与 CPU 交互，对从 CPU 收到的 I/O 命令进行译码
	- CPU 启动设备时，将启动命令发送给控制器，同时通过地址线将地址发送给控制器，由控制器的 I/O 逻辑对地址进行译码，并对所选设备进行控制
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602152701.png)

##### 3）类型
- **按数据传送方式**：
	- 并行接口
	- 串行接口
- **按主机访问 I/O 设备的控制方式**：
	- 程序查询接口
	- 中断接口
	- DMA 接口
- **按功能选择的灵活性**：
	- 可编程接口
	- 不可编程接口

#### （3）I/O 端口
##### 1）基本概念
- **I/O 端口**：指设备控制器中可被 CPU 直接访问的寄存器，有三种类型
	- **数据寄存器**：用于缓存从设备送来的输入数据，或从 CPU 送来的传输数据
	- **状态寄存器**：保存设备的执行结果或状态信息，以供 CPU 读取
	- **控制寄存器**：由 CPU 写入，以便启动命令或更改设备模式
- I/O 端口要想能够被 CPU 访问，就要对各个端口进行编制，每个端口对应一个端口地址

##### 2）寄存器编址方式
- **独立编址**：
	- 指为每个端口分配一个 I/O 端口号
	- I/O 端口的地址空间与主存地址空间**独立**
	- 两者范围可以重叠，相同地址可能属于不同的地址空间
	- 只有 OS 使用特殊的 I/O 指令才能访问端口【普通用户程序不能访问端口】
	- **优点**：
		- I/O 端口数比主存单元少得多，只需少量地址线，使得 **I/O 端口译码简单，寻址速度更快**
		- 使用专用 I/O 指令，可使**程序更加清晰**，便于理解和检查
	- **缺点**：
		- I/O 指令少，只提供简单的传输操作，所以程序**设计的灵活性较差**
		- CPU 需要提供两组独立的存储器和设备的读/写控制信号，**增加了控制的复杂性**

- **统一编址**：
	- 又称**内存映射 I/O**
	- 指将主存地址空间分出一部分给 I/O 端口进行编址，I/O 端口和主存单元在同一地址空间的**不同分段**中
	- **根据地址范围**就能区分访问的是 I/O 端口还是主存单元
	- 用**统一的访存指令**就可访问 I/O 端口
	- **优点**：
		- 不须专门的 I/O 指令，使得 CPU 访问 I/O 的操作**更加灵活方便**
		- 使端口有较大的编址空间
	- **缺点**：
		- 端口地址占用了部分主存地址空间，使**主存的可用容量变小**
		- 识别 I/O 端口时全部地址线都需参加译码，使**译码电路更加复杂**，降低寻址速度

### 2、I/O 控制方式
- **I/O 控制**：指控制设备和主机之间的数据传送
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602171054.png)

#### （1）程序直接控制方式
- CPU 对 I/O 设备的控制采用轮询的 I/O 方式，又称**程序轮询方式**
- **CPU 干预的频率**：
	- 很频繁，I/O 操作开始之前、完成之后需要 CPU 介入
	- 在**等待 I/O 完成的过程中 CPU 需要不断地轮询检查**
- 数据的传送单位：每次读/写**一个字**
- 数据的流向：
	- 读操作（数据输入）：I/O 设备 ---> CPU 寄存器 ---> 内存
	- 写操作（数据输出）：内存 ---> CPU 寄存器 ---> I/O 设备
- **优点**：实现简单
- **缺点**：
	- **CPU 和 I/O 设备只能串行工作**
	- CPU 需要一直轮询检查，**长期处于“忙等”状态**，CPU 利用率低
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602163906.png)

![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602163731.png)

#### （2）中断驱动方式
- **基本思想**：允许 I/O 设备主动打断 CPU 的运行并请求服务，从而“解放”CPU，使得其向 I/O 控制器发送读命令后可以继续做其他有用的工作
- **CPU 干预的频率**：
	- 每次 I/O 操作开始之前、完成之后需要 CPU 介入
	- 等待 I/O 完成的过程中 CPU 可以切换到别的进程执行
- 数据的传送单位：每次读/写**一个字**
- 数据的流向：
	- 读操作（数据输入）：I/O 设备 ---> CPU 寄存器 ---> 内存
	- 写操作（数据输出）：内存 ---> CPU 寄存器 ---> I/O 设备
- **优点**：
	- I/O 控制器会通过中断信号主动报告 I/O 已完成，CPU 不再需要不停地轮询
	- **CPU 和 I/O 设备可并行工作**，CPU 利用率明显提升
- **缺点**：
	- 每个字在 I/O 设备与内存之间的传输，都需要经过 CPU
	- 频繁的中断处理会消耗较多的 CPU 时间
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602164525.png)

#### （3）DMA 方式
- **基本思想**：是在 I/O 设备和内存之间开辟直接的数据交换通路，彻底"解放” CPU
- **CPU 干预的频率**：
	- 仅在传送一个或多个数据块的**开始和结束时**，才需 CPU 干预
	- 整块数据的传送是在 DMA 控制器的控制下完成的
- 数据的传送单位：每次读/写**一个或多个块**【连续的】
- 数据的流向：
	- 读操作（数据输入）：I/O 设备 ---> 内存
	- 写操作（数据输出）：内存  ---> I/O 设备
- **优点**：
	- 数据传输以“块”为单位，CPU 介入频率进一步降低
	- 数据的传输不再需要先经过 CPU 再写入内存，数据传输效率进一步增加
	- CPU 和 I/O 设备的并行性得到提升
- **缺点**：
	- CPU 每发出一条 I/O 指令，只能读/写一个或多个连续的数据块
	- 如果要读/写多个离散存储的数据块，或者要将数据分别写到不同的内存区域时，CPU 要分别发出多条I/O 指令，进行多次中断处理才能完成
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602165701.png)

#### （4）通道控制方式
- I/O 通道是一种特殊的处理机，可执行一系列通道指令
- 与 CPU 相比，通道可以执行的指令很单一，并且通道程序是放在主机内存中的，也就是说通道与 CPU 共享内存
- **CPU 干预的频率**：
	- 极低
	- 通道会根据 CPU 的指示执行相应的通道程序，只有完成一组数据块的读/写后才需要发出中断信号，请求 CPU 干预
- 数据的传送单位：每次读/写**一组数据块**
- 数据的流向【**在通道的控制下进行**】：
	- 读操作（数据输入）：I/O 设备 ---> 内存
	- 写操作（数据输出）：内存  ---> I/O 设备
- **优点**：
	- **CPU、通道、I/O 设备可并行工作**，资源利用率很高
	- 一个通道可以控制**多台设备与内存**的数据交换
- **缺点**：实现复杂，需要专门的通道硬件支持
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240602170531.png)


### 3、I/O 软件层次结构
- 将系统中的设备管理模块分为若干个层次，**每层都利用其下层提供的服务**，完成输入/输出功能中的某些子功能，并**屏蔽这些功能的实现细节**，向高层提供服务
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604145317.png)

#### （1）用户层软件
- 用户层软件**实现了与用户交互的接口**
- 用户可直接使用该层提供的、与 I/O 操作相关的**库函数**对设备进行操作
- 用户层软件将用户请求翻译成格式化的 I/O 请求，并通过**系统调用**请求操作系统内核【下三层】的服务

#### （2）设备独立性软件
- **设备独立性**：又称**设备无关性**，使得应用程序独立于具体使用的物理设备
- 为实现设备独立性，引入了**逻辑设备**和**物理设备**两个概念
- 使用逻辑设备名的**好处**：
	- 增加设备分配的灵活性
	- 易于实现 I/O 重定向，用于 I/O 操作的设备可以更换 ，而不必改变应用程序
- 为实现设备独立性，必须在驱动程序之上设置一层**设备独立性软件**，主要功能：
	- 向上层提供统一的调用接口（如 read/write 系统调用）
	- 设备的保护
	- 差错处理
	- 设备的分配与回收
	- 数据缓冲区管理
	- 建立逻辑设备名到物理设备名的映射关系，根据设备类型选择调用相应的驱动程序

#### （3）设备驱动程序
- **与硬件直接相关**，负责**具体实现系统对设备发出的操作命令**，驱动 I/O 设备工作的驱动程序
- 每类设备设置一个设备驱动程序，它是 I/O 进程与设备控制器之间的通信程序，通常**以进程的形式存在**
- 设备具体的差别被设备驱动程序所封装，设备驱动程序向上层用户程序提供一组标准接口，用于接收上层软件发来的抽象 I/O 要求（如 read /write 命令），转换为具体要求后，**发送给设备控制器，控制 I/O 设备工作**
- 它也将由设备控制器发来的信号传送给上层软件，从而为 I/O 内核子系统隐藏设备控制器之间的差异

#### （4）中断处理程序
- 保存被中断进程的 CPU 环境，转入相应的中断处理程序进行处理，处理完毕再恢复被中断进程的现场后，返回到被中断进程
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604152911.png)

### 4、应用程序 I/O 接口
#### （1）I/O 接口的分类
- **字符设备接口**：
	- 字符设备：指数据的存取和传输是**以字符为单位**的设备（如键盘、打印机等）
	- 基本特征：
		- 传输速率较低、不可寻址
		- I/O 通常采用中断驱动方式
- **块设备接口**：
	- 块设备：指数据的存取和传输是**以数据块为单位**的设备（如磁盘）
	- 基本特征：
		- 传输速率高、可寻址
		- I/O 通常采用 DMA 方式
- **网络设备接口**：
	- 又称网络套接字（socket）接口
	- 套接字接口的系统调用使应用程序创建的本地套接字连接到远程应用程序创建的创建的套接字，通过此连接发送和接收数据

#### （2）阻塞 I/O 和非阻塞 I/O
- **阻塞 I/O** ：
	- 指当用户进程调用 I/O 操作时，进程就被阻塞，需要等待 I/O 操作完成，进程才被唤醒继续执行
	- 大多数 OS 提供的 I/O 接口都是采用阻塞 I/O
	- **优点**：操作简单，实现难度低，适合并发量小的应用开发
	- **缺点**：I/O 执行阶段进程会一直阻塞下去
- **非阻塞 I/O** ：
	- 指用户进程调用 I/O 操作时，不阻塞该进程，但进程需要通过轮询的方式来查询 I/O 操作是否完成
	- **优点**：进程在等待 I/O 期间不会被阻塞，可以做其他事情，适合并发量大的应用开发
	- **缺点**：轮询方式询问 I/O 结果，会占用 CPU 的时间


## 二、设备独立性软件
### 1、设备独立性软件
- 与设备无关的软件是 I/O 系统的最高层软件，它的下层是设备驱动程序，其间的界限因操作系统和设备的不同而有所差异

### 2、高速缓存与缓冲区
#### （1）磁盘高速缓存
- 操作系统中使用磁盘高速缓存技术来提高磁盘的 I/O 速度，对访问高速缓存要比访问原始磁盘数据更为高效 
- 磁盘高速缓存**逻辑上属于磁盘**，**物理上是驻留在内存中的盘块**
- 磁盘高速缓存在内存中分为两种形式：
	1. 在内存中开辟一个独立的空间作为磁盘高速缓存。大小固定
	2. 把未利用内存空间作为一个缓冲池，仅供请求分页系统和磁盘 I/O 时共享

#### （2）缓冲区
- **引入缓冲区的目的**：
	- 缓和 CPU 与 I/O 设备间速度不匹配的矛盾
	- 减少对 CPU 的中断频率，放宽对 CPU 中断响应时间的限制
	- 解决基本数据单元大小（即数据粒度）不匹配的问题
	- 提高 CPU 和 I/O 设备之间的并行性
- **实现方法**：
	- 采用硬件缓冲器，但由于成本太高，除一些关键部位外，一般不采用硬件缓冲器
	- 采用缓冲区（位于内存区域）
- 根据系统设置**缓冲区的个数**，缓冲技术可以分为：
##### 1）单缓冲
- T时间：数据从磁盘 ---> 缓冲区
- M时间：数据从缓冲区 ---> 用户
- C 时间：CPU 对一块数据处理的时间
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604162046.png)
- **注意**：
	- 当缓冲区数据非空时，不能往缓冲区冲入数据，只能从缓冲区把数据传出
	- 当缓冲区为空时，可以往缓冲区冲入数据，但必须把缓冲区充满以后，才能从缓冲区把数据传出
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604162941.png)
- **结论**：采用单缓冲策略，处理一块数据平均耗时 **Max (C, T)+M**

##### 2）双缓冲
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604163543.png)
- 假设初始状态为：工作区空，其中一个缓冲区满，另一个缓冲区空
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604163708.png)
- **结论**：采用双缓冲策略，处理一个数据块的平均耗时为 **Max (T, C+M)**

##### 3）循环缓冲
- 将多个**大小相等**的缓冲区连接成一个**循环队列**
- 下图中橙色表示已充满数据的缓冲区，绿色表示空缓冲区
- 当需要向缓冲区中冲入数据时，只要找到in指针指向的空缓冲区，向其中冲入数据，然后再把in指针指向下一个空缓冲区
- 当需要取出满缓冲区的内容时，找到 out 指针执行的满缓冲，读完数据后，将指针指向下一个满缓冲区。
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604164039.png)

##### 4）缓冲池
- 缓冲池由系统中共用的缓冲区组成
- 缓冲区**按使用状况**可以分为：
	- **空缓冲队列**
	- **输入队列**：存储的是从设备发送给内存的数据
	- **输出队列**：存储的是从内存发送给设备的数据
- 根据一个缓冲区**在实际运算中扮演的功能**不同分为四种工作缓冲区：
	- 用于**收容输入数据**的工作缓冲区（hin）
	- 用于**提取输入数据**的工作缓冲区（sin）
	- 用于**收容输出数据**的工作缓冲区（hout）
	- 用于**提取输出数据**的工作缓冲区（sout）
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604164403.png)
- **收容输入**：
	- 输入进程需要输入数据时，从空缓冲队列的队首摘下一个空缓冲区，作为收容输入工作缓冲区，然后将数据输入其中，装满后再将它挂到输入队列的队尾
- **提取输入**：
	- 计算进程需要输入数据时，从输入队列的队首取得一个缓冲区，作为提取输入工作缓冲区，从中提取数据，用完该数据后将它挂到空缓冲队列的队尾
- **收容输出**：
	- 计算进程需要输出数据时，从空缓冲队列的队首取得一个空缓冲区，作为收容输出工作缓冲区，当其中装满数据后，再将它挂到输出队列的队尾
- **提取输出**：
	- 输出进程需要输出数据时，从输出队列的队首取得一个装满输出数据的缓冲区，作为提取输出工作缓冲区，当数据提取完后，再将它挂到空缓冲队列的队尾

#### （3）高速缓存与缓冲区的对比
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20240604165750.png)
