
# 第4章 网络层 #

​		

## 网络层功能

- 网络层的主要任务就是**将分组从源主机经过多个网络和多段链路传输到目的主机**，

  可以将该任务分为**分组转发**和**路由选择**两种重要的功能

- 网络层向其上层提供两种服务
  - 面向连接的虚电路服务
  - 无连接的数据报服务

### 提供的服务：数据报和虚电路

####  面向连接的虚电路服务 

![image-20231112115609269](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112115609269.png)

+ **可靠的通信由网络来保证**
+ 必须**建立网络层的连接----虚电路VC**(`Virtual Circuit`)
+ 通信双方**沿着已建立的虚电路发送分组**
+ 目的主机的地址仅在连接建立阶段使用，之后每个**分组的首部只需携带一条虚电路的编号**(构成虚电路的每一段链路都有一个虚电路编号)
+ 这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方(无差错按序到达、不丢失、不重复)
+ **通信结束后，需要释放之前所建立的虚电路**
+ 很多广域分组交换网都使用面向连接的虚电路服务。例如，曾经的X.25和逐渐过时的帧中继（Frame Relay，FR）、异步传输模式（Asynchronnous Transfer Mode，ATM）

####  无连接的数据报服务 

![image-20231112115700164](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112115700164.png)

+ **可靠通信应当由用户主机来保证**

+ **不需要建立网络层连接**

+ **每个分组可走不同路径**

+ 每个分组的**首部必须携带目的主机的完整地址**

+ 这种通信方式所传送的**分组可能误码、丢失、重复和失序**

+ 由于网络本身不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉

> 因特网采用了这种设计思想，也就是**将复杂的网络处理功能置于因特网的边缘(用户主机和其内部的运输层)**，而将相对简单的尽最大努力的分组交付功能置于因特网核心

#### 总结：数据报和虚电路比较

|                        | 数据报服务                                                   | 虚电路服务                                               |
| ---------------------- | ------------------------------------------------------------ | -------------------------------------------------------- |
| **连接的地址**         | 不需要                                                       | 必须                                                     |
| **目的地址**           | 每个分组都有完整的目的地址                                   | 仅在连接建立阶段使用，之后每个分组使用长度较短的虚电路号 |
| **路由选择**           | 每个分组独立地进行路由选择和转发                             | 属于同一条虚电路的分组按照同一路由转发                   |
| **分组顺序**           | 不保证有序                                                   | 有序                                                     |
| **可靠性**             | 不保证可靠通信，可靠性由用户主机保证                         | 可靠性由网络保证                                         |
| **对网络故障的适应性** | 出故障的结点丢失分组，其他分组路径选择发生变化时可以正常传输 | 所有经过故障结点的虚电路均不能工作                       |
| **差错处理和流量控制** | 由用户主机进行流量控制，不保证数据报的可靠性                 | 可由分组交换网负责，也可由用户主机负责                   |

### 异构网络互联

> 要在全球范围内钯数以百万计的网络互连起来，并且能够互相通信，是一项非常复求的任务（不同的寻址方案、不同的网络接入机制、不同的差错处理方法，不同的路由选择机制等等）
>
> 用户的需求是多样的，没有一种单一的网络能够适应所有用户的需求，网络层所要研究的任务之一就是使这些异构的网络互连

网络互连是指将两个以上的计算机网络，通过一定的方法，用一些中间设备（又称中继系统）相互连接起来，以构成更大的网络系统。根据所在的层次，中继系统分为以下4种。

1. 物理层中继系统：转发器，集线器。
2. 数据链路层中继系统：网桥或交换机。
3. 网络层中继系统：路由器。
4. 网络层以上的中继系统：网关。

使用物理层或数据链器是的中继系统时，只是把一个网络扩大了，而从网络层的角度看，它仍然是同一个网络，一般并不称为网络互连。

因此**网络互连通常是指用路由器进行网络互连和路出选择。**

> 路由器是一台专用计算机，用于在互联网中进行路由选择。由于历史原因，许多有关 TCP/IP 的文献也把网络层的路由器称为网关

TCP/IP 体系在网络互连上采用的做法是在网络层采用标准化协议，但相互连接的网络可以是异构的

下图表示用许多计算机网络通过一些路由器进行互连。由于参加互连的计算机网络都使用相同的 IP 协议，因此可以把互连后的网络视为一个虚拟的IP网络

![image-20231112201120216](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201120216.png)

## IP协议概述

> 网际协议（Internet Protocol，IP）是**TCP/IP体系结构**网际层中的**核心协议**

网际协议`IP`、传输控制协议`TCP`、`TCP/IP`体系结构是由“因特网之父”*Robert Kalm*和*Vint Cerf*二人共同研发的，1974年5月发布了TCP/IP的第一个版本

![image-20231112201518149](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201518149.png)

### IP地址特点

* 每个IP地址都有**网络号和主机号**两部分组成。IP地址管理机构ICANN分配地址时只分配网络号，而主机号由该分配到网络的单位自行分配，方便了IP地址的维护和管理；路由器只根据目的主机的网络号来转发分组（不考虑主机号），减小了路由表的存储空间
* 用转发器或桥接器（网桥等）连接的若干LAN仍然是同一个网络（同一个广播域），因此该LAN中的所有主机的IP地址网络号必须相同，主机号必须不同
* 在IP地址中，所有分配到网络号的网络（无论是LAN还是WAN）都是平等的
* 路由器的每个端口都有一个不同网络号的IP地址

### IP数据报发送转发过程 

> 同一个网络之间的主机可以直接通信，不同网络之间的主机通信需要路由器中转
>
> IP数据报的发送和转发过程包括以下两个过程：
>
> 1. 主机发送IP数据报
> 2. 路由器转发IP数据报

1. **源主机如何判断目的主机是否和自己在同一个网络中？**

> 将自身的`IP`地址与子网掩码**相与**得到自身的网络号`1`，再将目的`IP`地址与自身子网掩码**相与**得到网络号`2`。若两个网络号相等，则说明处在同一个网络

![image-20231112201539572](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201539572.png)

2. **主机如何知道应该把IP数据报交给哪个路由器进行转发呢？**

> 通过设置默认网关。
>
> 所谓默认网关，即当路由表中查不到数据时会将数据发往的路由器端口`IP`地址。

![image-20231112201604731](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201604731.png)

3. **路由器收到`IP数据报`后如何转发？**

- 检查收到的IP数据报是否正确

  生存时间是否结束；首部是否误码

  若不正确，则丢弃该IP数据报，并向发送该IP数据报的源主机发送差错报告

- 基于IP数据报首部中的目的IP地址在路由表中进行查找

  若找到匹配的路由条目，则按该路由条目的指示进行转发

  否则丢弃该IP数据报，并向发送该IP数据报的源主机发送差错报告

![image-20231112201624869](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201624869.png)

将目的`IP`地址与自身子网掩码**相与**得到网络号

![image-20231112201637141](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201637141.png)

![image-20231112201642867](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201642867.png)

广播`IP数据报`的情况

>路由器不转发广播IP数据报，即**路由器隔离广播域**。
>如果因特网中数量巨大的路由器收到广播IP数据报后都进行转发，则会造成巨大的广播风暴，严重浪费因特网资源

![image-20231112201654291](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201654291.png)

#### 例题

![image-20231112201715566](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201715566.png)

![image-20231112201721650](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201721650.png)

![image-20231112201730810](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112201730810.png)

![](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119111634754.png)



## IPv4

### 概述

- IPv4地址是给因特网（Internet）上的**每一个主机（或路由器）的每一个接口**分配的一个在全世界范围内**唯一的32比特的标识符**

- IPv4即现在普遍使用的IP协议（版本4）
- IP协议定义数据传送的基本单元——IPv4分组及其确切的数据格式
- IP协议也定义一些规则包括：指明分组如何处理、错误怎样控制。特别是IP协议还包括非可靠投递的思想，以及与此关连的分组路由选择的思想

### IPv4分组

IP协议定义数据传送的基本单元——IP分组及其确切的数据格式

> 在TCP/IP标准中，各种数据格式常常以`32比特`（即`4字节`）为单位来描述

* 固定部分

  每个`IPv4数据报`都**必须要包含**的部分

* 某些`IPv4数据报`的首部，除了包含`20`字节的固定部分，还包含一些可选字段来增加IPv4数据报的功能

* 标识、标识、片位移共同用于`IPv4数据报分片`

#### 数据报分片

- **IPv4数据报分片**

  **标识、标志、片偏移**区分出了一个IP数据报分片

- **最大传送单元MTU**

  ![image-20231119113201227](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119113201227.png)

  当IPv4数据报长度超过MTU时，无法封装成帧，需要将原IPv4数据报分片为若干个更小的IPv4数据报

  以太网的MTU是`1500B`

![image-20231112202209562](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202209562.png)

#### IPv4数据报首部格式

![image-20231112202241515](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202241515.png)

+ **版本**

  占`4`比特

  通信双方使用的`IP`协议版本必须一致。目前广泛使用的`IP`协议版本为号为`4`(IPv4)

+ **首部长度**

  占`4`比特，该字段取值**以`4`字节为单位**

  最小取值为`0101`（十进制取值为`5`）表示IP数据报首部只有`20字节`固定部分

  (`4`字节单位，所以取值`5`对应`20`字节）

  最大取值为`1111`(十进制取值为`15`)，表示IP数据报首部包含20字节固定部分和最大40字节可变部分

  (`4`字节单位，所以取值`15`对应`60`字节）

+ **可选字段（实际很少采用）**

  长度从`1-40`个字节不等。**用来支持排错、测量及安全等措施**

  可选字段增加了`IP`数据报的功能，但这同时也**使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理IP数据报的开销**。实际上可选字段很少被使用

+ **填充字段**

  确保首部长度为`4`字节长度的整数倍，使用全`0`进行填充

+ **区分服务(一般不使用)**

  占`8`比特

  利用该字段的不同数值可提供不同等级的服务质量，只有在使用区分服务时，该字段才起作用。一般情况下不使用该字段

+ **总长度**

  占`16`比特，**以字节为单位**，表示`IP`数据报的总长度（**首部+数据载荷**）

  最大取值：$2^{16}-1$（十进制`65535`）

![image-20231112202321669](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202321669.png)

+ **标识**

  - 占`16`比特，**属于同一个数据报的各分片数据报应该具有相同的标识**

  - `IP`软件维持一个计数器，每产生一个数据报，计数器值`+1`，并将此值赋给标识字段

+ **标志  **

  占`3`比特，各比特含义如下

  + 最低位`MF(More Fragment)`：`1`表示后面还有分片，`0`表示这是最后一个分片
  + 中间位`DF(Don’t Fragment)`：`1`表示不允许分片，`0`表示允许
  + 最高位为保留位：必须为`0`

+ **片偏移(必须是整数)**

  占`13`比特，指出分片数据报的**数据载荷部分偏移其在原数据报的位置有多少单位**

  **片偏移以8个字节为单位**

+ **生存时间**

  占`8`比特，最初以秒为单位，最大生存周期为$(11111111)$(十进制`255秒`)

  路由器转发`IPv4数据报`时，将`IP`数据报首部中的该字段值减去`IP`数据报在本路由器上耗费的时间，若不为`0`【说明路由器消耗时间后还活着】就转发，否则丢弃

  **现在以"跳数"为单位，路由器转发IP数据报时，将IP数据报首部中的该字段值减1，若不为0就转发，否则丢弃**【防止兜圈】

+ **协议**

  占`8`比特，指明`IPv4`数据报的**数据载荷是何种协议数据单元PDU**

  ![image-20231112202434619](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202434619.png)

- **首部检验和**

  占`16`比特，用来检测首部在传输过程中是否出现差错，比`CRC`检验码简单，称为**因特网检验和**

  `IP`数据报每经过一个路由器，路由器都要重新计算首部检验和，因为某些字段【生存时间、标志、片偏移等】的取值可能发生变化

  由于`IP`层本身不提供可靠传输服务，并且计算首部校验和是一项耗时的操作，因此**在`IPv6`中，路由器不再计算首部校验和，从而更快转发`IP`数据报**

![image-20231112202448449](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202448449.png)

![image-20231112202457215](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202457215.png)

![image-20231112202502811](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202502811.png)

+ **源IP地址和目的IP地址**

  各占`32比特`，用来填写发送该`IP`数据报的源主机`IP`地址和接收该`IP`数据报的目的主机

#### 总结：IP数据报首部

在IP数据报首部中有三个关于长度的标记：首部长度4B、总长度1B、片位移8B，需要记住

#### 例题

![image-20231112202517390](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202517390.png)

![image-20231112202522679](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202522679.png)

### IPv4分类编址与NAT

`IPv4`地址就是因特网上的**每一台主机(或路由器)的每一个接口**分配一个在全世界范围内是**唯一的`32`比特(4B)的标识符**

`IPv4`地址由因特网名字和数字分配机构（Internet Corporation for Assigned Names and Numbers，`ICANN`）进行分配

IPV4地址的编址方法经历了**三个阶段**

![image-20231112202543225](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202543225.png)

无论哪一类IP地址，都由**主机号**和**网络号**组成

- 主机号：标志主机（或路由器）的**接口**
  - **同一个网络**中，**不同**主机（或路由器）的**接口**的IPv4地址的**主机号必须各不相同**，以便区分各主机（或路由器）的接口
- 网络号：标志主机（或路由器）的接口所连接到的**网络**
  - **同一个网络**中，**不同**主机（或路由器）的**接口**的IPv4地址的**网络号必须相同**，表示它们属于同一个网络

![image-20231119091720276](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119091720276.png)



**IPv4地址的表示方法——点分十进制表示方法** 

`32`比特的IPV4地址不方便阅读，记录以及输入等，因此IPV4地址采用点分十进制表示方法

![image-20231112202606246](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202606246.png)

#### 早期IPv4编址：分类编址

![image-20231112202629555](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112202629555.png)

![image-20231112203240946](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203240946.png)

> - A类地址可用网络数：$2^{8-1}-2=126$，减2是去掉最小网络号0和最大网络号127
> - A类网络中可分配的地址数量为$2^{24-1}-2=16777214$，减2是去掉主机号为全0的网络地址和全1的广播地址
>
> - 最小网络号为0，表示本网络，不能指派
> - 大网络号为127，作为本地环回测试地址，不能指派
>   - 最小的本地环回测试地址为127.0.0.1
>   - 最大的本地环回测试地址为127.255.255.254
> - 最小可指派的网络号为1，网络地址为1.0.0.0
> - 最大可指派的网络号为126，网络地址为126.0.0.0

A类、B类和C类地址都是**单播地址**，只有单播地址可以**分配给网络中的主机（或路由器）的各接口**

**特殊的IP地址**

* 202.98.174.0 ，主机号全0标识网络本身

* 202.98.174.255，主机号全1标识本网络的广播地址（直接广播地址）

* 127.x.x.x，保留为环回自检（Loopback Text）地址，此地址表示网络本身，目的地址为环回地址的IP数据报永远不会出现在任何网络上

* 0.0.0.0，32位全为0，表示本网络上的主机

* 255.255.255.255，32位全为1，表示整个TCP/IP网络的广播地址（受限广播地址）

  > 实际使用时，由于路由器对广播域的隔离，255.255.255.255等效为本网络的广播地址

##### 例题

![](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119092753013.png)

####  网络地址转换NAT和私有IP地址 ####

网络地址转换`（Network Address Translation，NAT）`技术于1994年被提出，用来缓解`IPv4`地址空间即将耗尽的问题

`NAT`能使大量使用**内部专用地址的专用网络用户共享少量外部全球地址**来访问因特网上的主机和资源，即通过将专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址

> 由于专用本地IP是可重用的，所以NAT大大节省了IP地址的消耗。同时，它隐藏了内部网络结构，从而降低了内部网络受到攻击的风险

此外，为了网络的安全，划出了部分IP地址为私有IP地址。私有IP地址只属于LAN，而不用于WAN，并且允许私有IP地址被LAN重复使用

私有IP地址网段：

* A类：1个A类网段：10.0.0.0——10.255.255.255
* B类：16个B类网段：172.16.0.0——172.31.255.255
* C类：256个C类网段：192.168.0.0——192.168.255.255

在因特网中的所有路由器，对目的地址是私有的一律不进行转发。这种采用私有IP地址的互联网称为专用互联网或本地互联网。私有IP地址也可称为可重用地址

这种方法需要在专用网络连接到因特网的路由器上安装`NAT`软件。装有`NAT`软件的路由器称为`NAT`路由器，它至少要有一个有效的外部全球地址`IP`。

这样，所有使用内部专用地址的主机在和外部因特网通信时，都要在`NAT`路由器上将其内部专用地址转换成`IP`。

> ![](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203419225.png)

由于绝大多数的网络应用都是使用运输层协议`TCP`或`UDP`来传送数据，因此可以**利用运输层的端口号和IP地址一起进行转换。**

这样，**用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信**。这种将端口号和`IP`地址一起进行转换的技术叫作**网络地址与端口号转换`NAPT（Network Address and Port Translation，NAPT）`**

现在很多家用路由器将家中各种智能设备（手机、平板、笔记本电脑、台式电脑、物联网设备等）接入因特网，这种路由器实际上就是一个`NAPT`路由器，但往往并不运行路由选择协议

### 子网划分与子网掩码 ###

**为什么需要？**

两级结构的缺点：

- IP地址利用率有时会很低
- 给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变得太坏
- 两级的IP地址不够灵活

![image-20231112203443740](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203443740.png)

* 子网划分纯属于一个单位内部的事情，单位对外仍然表现为没有划分子网的网络
* 从主机号借用若干比特作为子网号，当然主机号也就减少了相同的比特

> 注意：划分子网只是把IP地址的主机号这部分进行划分，而不改变IP地址原来的网络号。因此，从一个IP地址本身或IP数据报的首部，无法判断源主机或者目的主机是否进行了子网划分 
>
> 子网中主机号全1或全0的地址不能随意指派，全0作子网的网络号，全1作子网的广播地址

**子网掩码**

![image-20231112203502616](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203502616.png)

**如何实现子网划分？**

**32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号**

+ 子网掩码使用左起**多个连续的比特`1`来对应网络号和子网号**(子网号来自原先的一部分主机号)
+ 子网掩码使用连续的比特`0`来对应主机号
+ 将划分子网的`IPv4`地址与其相应的子网掩码进行**(逻辑与运算)(即掩码是1的部分)**就可得到`IPv4`地址所在子网的网络地址

![image-20231112203514118](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203514118.png)

![image-20231112203520882](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203520882.png)

**只要给定了一个分类的IPv4地址及其相应的子网掩码，就可以得出子网划分的全部细节**

**默认子网掩码：**指在**未划分子网的情况下使用的子网掩码**

![image-20231119095411712](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119095411712.png)

#### 例题

![image-20231112203543628](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203543628.png)

![image-20231112203550632](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203550632.png)

### 无分类编址：CIDR

无分类域间路由选择CIDR`Classless Inter-Domain Routing，CIDR `

+ `CIDR`消除了传统的`A`类、`B`类和`C`类地址，以及划分子网的概念,因此可以更有效的分配地址空间

+ `CIDR`使用**"斜线记法"**，或称`CIDR`记法。即在`IPv4`地址后面加上斜线"`/`"，**在斜线后面写上网络前缀所占比特数量**

![image-20231112203601599](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203601599.png)

![image-20231112203617081](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203617081.png)

实际上，无分类域间路由选择`CIDR`是将网络前缀都相同的、连续的多个无分类IPv4地址，组成一个`CIDR地址块`，只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的以下全部细节：

> 1. 地址块中的最小地址
> 2. 地址块中的最大地址
> 3. 地址块中的地址数量
> 4. 地址块中聚合某类网络（A、B、C）的数量
> 5. 地址掩码

![image-20231112203640735](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203640735.png)

### 路由聚合

> 如路由器`A`上连接同一网络的多台主机，路由器`B`与`A`相连。若`A`将所有主机的具体`IP`地址都报给`B`，则路由器`B`中会增加多项路由条目。可实际上`B`向`A`中任意一个主机转发数据的时都是走同一个端口，因此我们可以**将这些网络的共同前缀提取出来成为新的网络号，同时将剩余主机号置0放入路由器B中**
>
> 如：`A`连接了`172.1.4.0/25`和`172.1.7.0/24`，则提取公共前缀聚合后变为`172.1.4.0/22`

![image-20231112203710011](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203710011.png)

* **网络前缀越长，地址块越小，路由越具体**
* 若路由器查表转发分组时发现有多条路由条目匹配，则选择网络前缀最长的那条路由条目，这称为**最长前缀匹配**，因为这样的路由更具体

#### 例题

![image-20231112203720992](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203720992.png)

![image-20231112203726360](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203726360.png)

![image-20231112203733348](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203733348.png)

## IPv4地址与MAC地址

### IPv4地址和MAC地址区别

1. `IPv4`与`MAC地址`的封装位置

![image-20231112204031759](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204031759.png)

2. 数据报传输过程中`IPv4地址`与`MAC地址`的变化情况

![image-20231112204042391](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204042391.png)

在数据包的传送过程中，数据包的**源IP地址和目的IP地址保持不变**

在数据包的传送过程中，数据包的**源MAC地址和目的MAC地址逐链路（或逐网络）改变**

**例题**

![image-20231112204111510](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204111510.png)

3. `IPv4地址`与`MAC地址`的关系

- 如果仅使用MAC地址进行通信，则会出现以下主要问题：
  - 因特网中的每台路由器的**路由表**中就必须**记录因特网上所有主机和路由器各接口的MAC地址**
  - 手工给各路由器配置路由表几乎是不可能完成的任务，即使使用路由协议让路由器通过相互交换路由信息来自动构建路由表，也会因为**路由信息需要包含海量的MAC地址信息而严重占用通信资**
  - **包含海量MAC地址的路由信息需要路由器具备极大的存储空间**，并且会给分组的**查表转发带来非常大的时延**
- 因特网的网际层**使用IP地址进行寻址**，就可使因特网中各**路由器**的路由表中的路由记录的数量大大减少，因为**只需记录部分网络的网络地址**，而不是记录每个网络中各通信设备的各接口的MAC地址
  - 路由器收到IP数据报后，根据其首部中的目的IP地址的网络号部分，基于自己的路由表进行查表转发

 ### 地址解析协议ARP

查表转发的结果可以指明IP数据报的下一跳路由器的IP地址，但无法指明该**IP地址所对应的MAC地址**。

因此，在数据链路层封装该IP数据报成为帧时，帧首部中的目的MAC地址字段就无法填写，该问题需要使用网际层中的**地址解析协议ARP来**解决



![image-20231112203750324](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203750324.png)

![image-20231112203757240](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203757240.png)

![image-20231112203804582](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203804582.png)

![image-20231112203810036](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203810036.png)

![image-20231112203816305](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203816305.png)

![image-20231112203821746](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203821746.png)

`ARP`**协议的相关注意事项**

* 由于ARP协议的主要用途是从网际层使用的IP地址解析出在数据链路层使用的MAC地址。因此，有的教材将ARP协议划归在网际层，而有的教材将ARP协议划归在数据链路层。这两种做法都是可以的
* 除了ARP请求报文和响应报文，ARP协议还有其他类型的报文，例如用于检查IP地址冲突的“无故ARP”（Gratuitous ARP）
* ARP协议没有安全验证机制，存在ARP欺骗和攻击等问题

### 网际报文控制协议（ICMP）

为了更**有效地转发IP数据报**以及提高IP数据报交付成功的机会，在网际层使用了网际控制报文协议`ICMP（Internet Control Message Protocol）`让主机或路由器报告差错和异常情况

ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去

`ICMP`分为：**差错报告报文**和**询问报文**

+ `ICMP`报文被封装在`IP`数据报中发送

![image-20231112203840009](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203840009.png)

#### `ICMP`报文类型 ####

##### 差错报告报文

用来向主机或路由器报告差错情况

1. **终点不可达**

**当路由器或主机不能交付数据报时，就向源点发送终点不可达报文**。具体可再根据`ICMP`的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络位置、目的主机未知等`13`种错误

![image-20231112203903225](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203903225.png)

2. **源点抑制**

**当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文**，使源点知道应当把数据报发送速率放慢

![image-20231112203915590](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203915590.png)

3. **时间超过(超时)**

当路由器收到一个目的`IP`地址不是自己的`IP`数据报，会将其**生存时间TTL字段**值减`1`。若结果不为`0`，则将该`IP`数据报转发出去；**若结果为0，除丢弃该IP数据报外，还要向源点发送时间超过报文**

![image-20231112203934884](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203934884.png)

**当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过报文**

4. **参数问题**

当路由器或目的主机收到`IP`数据报后，根据其首部中的检验和字段发现首部在传输过程中**出现了误码，就丢弃该数据报，并向源点发送参数问题报文**

![image-20231112203955985](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112203955985.png)

5. **改变路由(重定向)**

**路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)**

如主机`1`的默认路由是`R1`，信息经过`R1`时，`R1`发现最佳路由不是自己，而是`R4`，所以通过`ICMP`告知主机`1`

![image-20231112204008985](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204008985.png)

> 以下情况不应发送`ICMP`差错报告报文:
>
> * 对ICMP差错报告报文不再发送ICMP差错报告报文
> * 对第一个分片的IP数据报片的所有后续数据报片都不发送ICMP差错报告报文
> * 对具有多播地址的IP数据报都不发送ICMP差错报告报文
> * 对具有特殊地址（例如127.0.0.0或0.0.0.0）的IP数据报不发送ICMP差错报告报文

##### 询问报文

用来向主机或路由器询问情况

1. **回送请求和回答**
   - `ICMP`回送请求报文是由主机或路由器向一个特定的目的主机发出的询问
   - 收到此报文的主机必须给源主机或路由器发送`ICMP`回送回答报文
   - 这种询问报文**用来测试目的站是否可达及了解其有关状态**

2. **时间戳请求和回答**
   - `ICMP`时间戳请求报文是请某个主机或路由器回答当前的日期和时间
   - 在`ICMP`时间戳回答报文中有一个`32`比特的字段，其中写入的整数代表从`1900`年`1`月`1`日起到当前时刻一共有多少秒
   - 这种询问报文**用来进行时钟同步和测量时间**

#### `ICMP`应用举例

1. 分组网间探测PING（ICMP回送请求和回答报文）
   - 用来**测试主机或路由器之间的连通性**
   - **使用的ICMP报文类型为回送请求和回答**
2. 跟踪路由tracerouce（ICMP时间超过报文）
   - 用于**探测IP数据报从源主机到达目的主机要经过哪些路由器**
   - 在**UNIX**版本中，具体命令为“**traceroute**”，其在运输层使用**UDP协议**，在网络层使用**ICMP报文类型只有差错报告报文**
   - 在**Windows**版本中，具体命令为“**tracert**”，其**应用层直接使用网际层的ICMP协议**，所使用的**ICMP报文类型有回送请求和回答报文以及差错报告报文**

## IPv6

### 从`IPv4`向`IPv6`过渡

#### 使用双协议栈

> 双协议栈（Dual Stack）是指在完全过渡到IPv6之前，使一部分主机或路由器装有`IPv4`和`IPv6`两套协议栈
>
> 双协议栈主机或路由器既可以和`IPv6`系统通信，又可以和`IPv4`系统通信
>
> 双协议栈主机或路由器记为`IPv6/IPv4`，表明它具有一个`IPv6`地址和一个`IPv4`地址
>
> 转换过程中一些字段无法转换，因此信息损失是无法避免的
>
> ![image-20231112204136851](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204136851.png)

* 双协议栈主机通过域名系统`DNS`查询目的主机采用的`IP`地址
  + 若`DNS`返回的是`IPv4`地址，则双协议栈的源主机就使用`IPv4`地址
  + 若`DNS`返回的是`IPv6`地址，则双协议栈的源主机就使用`IPv6`地址

#### 使用隧道技术

1. 当`IPv6`数据报要进入`IPv4`网络时，将`IPv6`数据报重新封装成`IPv4`数据报，即**整个`IPv6`数据报成为`IPv4`数据报的数据载荷**
2. 封装有`IPv6`数据报的`IPv4`数据报在`IPv4`网络中传输
3. 当`IPv4`数据报要离开`IPv4`网络时，再将其数据载荷（即原来的`IPv6`数据报）取出并转发到`IPv6`网络

![image-20231112204152299](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204152299.png)

### IPv6的主要特点

![image-20231112204206803](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204206803.png)

### IPv6数据报的首部

1. 基本首部
2. 拓展首部

#### `IPv6`数据报的基本首部

![image-20231112204231339](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204231339.png)

![image-20231112204237476](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204237476.png)

![image-20231112204244694](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204244694.png)

> - `IPv6`将`IPv4`数据报首部中不必要的功能取消了，这使得`IPv6`数据报基本首部中的字段数量减少到只有`8`个
> - 但由于`IPv6`地址的长度扩展到了`128`比特，因此使得`IPv6`数据报基本首部的长度反而**增大到了`40`字节**，比`IPv4`数据报首部固定部分的长度（`20字节`）增大了`20字节`
>   - 取消了首部长度字段，因为IPv6数据报的首部长度是固定的40字节
>   - 取消了区分服务（服务类型）字段，因为IPv6数据报首部中的通信量类和流标号字段实现了区分服务字段的功能
>   - 取消了总长度字段，改用有效载荷长度字段。这是因为IPv6数据报的首部长度是固定的40字节，只有其后面的有效载荷长度是可变的
>   - 取消了标识、标志和片偏移字段，因为这些功能已包含在IPv6数据报的分片扩展首部中
>   - 把生存时间TTL字段改称为跳数限制字段，这样名称与作用更加一致
>   - 消了协议字段，改用下一个首部字段
>   - 取消了首部检验和字段，这样可以加快路由器处理IPv6数据报的速度
>   - 取消了选项字段，改用扩展首部来实现选项功能

**版本字段**

> 长度为`4`比特，用来表示`IP协议`的版本。对于`IPv6`该字段的值是`6`

**通信量字段**

> 长度为`8`比特，该字段用来区分不同的`IPv6`数据报的类别或优先级。目前正在进行不同的通信量类性能的实验

**流水号字段：长度为`20`比特**

> IPv6提出了**流**的抽象概念
>
> * **“流”就是因特网上从特定源点到特定终点（单播或多播）的一系列IPv6数据报（如实时音视频数据的传送），而在这个“流”所经过的路径上的所有路由器都保证指明的服务质量**
>
> - 所有属于同一个流的IPv6数据报都具有同样的流标号。换句话说，**流标号用于资源分配**
>
> - 流标号对于实时音视频数据的传送特别有用，但对于传统的非实时数据，流标号则没有用处，把流标号字段的值置为`0`即可

**有效载荷长度字段**

> 长度为`16`比特，它指明`IPv6`数据报基本首部后面的有效载荷（包括扩展首部和数据部分）的字节数量
>
> * 该字段以字节为单位，最大取值为`65535`，因此`IPv6`数据报基本首部后面的有效载荷的最大长度为`65535`字节

**下一个首部字段**

> 长度为`8`比特。该字段相当于`IPv4`数据报首部中的**协议字段或可选字段**
>
> * 当`IPv6`数据报没有扩展首部时，该字段的作用与`IPv4`的协议字段一样，它的值指出了`IPv6`数据报基本首部后面的数据是何种协议数据单元`PDU`
> * 当`IPv6`数据报基本首部后面带有扩展首部时，该字段的值就标识后面第一个扩展首部的类型
>
> ![image-20231124192146974](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124192146974.png)

**跳数限制字段**

> 长度为`8`比特。该字段用来**防止`IPv6`数据报在因特网中永久兜圈**
>
> * 源点在每个`IPv6`数据报发出时即设定某个跳数限制（最大255跳）
> * 每个路由器在转发`IPv6`数据报时，要先把跳数限制字段中的值减`1`。当跳数限制的值为`0`时，就把这个`IPv6`数据报丢弃（即不转发）

**源地址和目的地址字段**

> 长度都为`128`比特。分别用来填写`IPv6`数据报的发送端的`IPv6`地址和接收端的`IPv6`地址

#### `IPv6`数据报的拓展首部 

* `IPv4`数据报如果在其首部中**使用了选项字段**，则在数据报的整个传送路径中的全部路由器，都要对选项字段进行检查，这就降低了路由器处理数据报的速度
* 实际上，在路径中的路由器对很多选项是不需要检查的。因此，为了提高路由器对数据包的处理效率，`IPv6`把原来`IPv4`首部中的**选项字段**都放在了**扩展首部**中，由路径两端的源点和终点的主机来处理，而**数据报传送路径中的所有路由器都不处理这些扩展首部**（除逐跳选项扩展首部）

> 在[RFC 2460]中定义了以下六种扩展首部
>
> 1. 逐条选项
> 2. 路由选择
> 3. 分片
> 4. 鉴别
> 5. 封装安全有效载荷
> 6. 目的站选项

+ **每一个扩展首部都由若干个字段组成**，它们的长度也各不相同
+ **所有扩展首部中的第一个字段都是`8`比特的下一个首部字段。**该字段的值指出在该扩展首部后面是何种扩展首部
+ 当使用多个扩展首部时，应按以上的**先后顺序**出现

### IPv6地址

`IPv6`**地址空间大小**

> 在`IPv6`中，每个地址占`128`个比特
>
> `IPv6`地址空间大小为$𝟐^{𝟏𝟐𝟖}$

#### `IPv6`地址表示方法(冒号十六进制记法)

![image-20231112204403329](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204403329.png)

在`IPv6`地址的冒号十六进制记法的基础上，再使用**“左侧零”省略**和**“连续零”压缩**，可使`IPv6`地址的表示更加简洁

- “左侧零”省略是指两个冒号间的十六进制数中最前面的一串0可以省略不写
- “连续零”压缩是指一连串连续的0可以用一对冒号取代

* 在一个`IPv6`地址中**只能使用一次“连续零”压缩**，否则会导致歧义
* 冒号十六进制记法还可结合点分十进制的后缀。这在`IPv4`向`IPv6`过渡阶段非常有用
* `CIDR`的斜线表示法在`IPv6`中仍然可用

![image-20231112204414599](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204414599.png)

![image-20231112204420261](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204420261.png)

![image-20231124192538175](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124192538175.png)

#### `IPv6`地址的分类

##### `IPv6`**数据报的目的地址分类**

1. 单播（unicast）

   > 传统的点对点通信

2. 多播（multicast）

   > 一点对多点的通信。数据报发送到一组计算机中的每一个
   >
   > `IPv6`**没有采用广播**的术语，而将广播看作多播的一个特例

3. 任播（anycast）

   > 这是`IPv6`新增的一种类型。任播的**终点是一组计算机，但数据报只交付其中的一个**，通常是按照路由算法得出的距离最近的一个

##### `IPv6`**地址分类**

![image-20231112204441845](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204441845.png)

![image-20231112204447857](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204447857.png)

![image-20231112204505562](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204505562.png)

![image-20231112204512369](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204512369.png)

![image-20231112204538423](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204538423.png)

### 网际控制报文协议

- IPv6与IPv4一样，都**不确保数据报的可靠交付**，因此IPv6也需要使用网际控制报文协议ICMP来向发送IPv6数据报的源主机**反馈一些差错信息**，相应的ICMP版本为ICMPv6
- ICMPv6比ICMPv4要复杂得多，它**合并了原来的地址解析协议ARP和网际组管理协议IGMP的功能**。因此与IPv6配套使用的网际层协议就只有ICMPv6这一个协议

![image-20231124194020380](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124194020380.png)

- **ICMPv6报文需要封装成IPv6数据报进行发送**

  ![image-20231124194052442](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124194052442.png)

  - ICMPv6报文可被用来**报告差错、获取信息、探测邻站或管理多播通信**

    ![image-20231124194156840](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124194156840.png)

## 路由算法

### 静态路由和动态路由

路由器转发分组是通过路由表转发的，而路由表是通过各种算法得到的。

从能否随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可以分为如下两大类。

* **静态路由算法**（非自适应路由算法)

  指由网络管理员**手工配置的路由信息**。当网络的拓扑结构或链路的状态发生变化时，网络管理员需要手工去修改路由表中相关的静态路由信息

  ![image-20231119142800161](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119142800161.png)

  ![image-20231119143001494](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119143001494.png)

  ![image-20231119143723325](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119143723325.png)

  > - `0.0.0.0/0`(相应的地址掩码为`0.0.0.0`)是默认路由条目中最短的网络前缀
  > - `192.168.2.1/32`(相应地址掩码为`255.255.255.255`)是特定主机路由条目中的最长网络前缀
  >
  > - 路由器在查找转发表转发IP数据报时，遵循“最长前缀匹配”的原则，因此**默认路由条目的匹配优先级最低**

  **特点**

  - 采用**人工配置**的方式给路由器添加网络路由、默认路由和特定主机路由等路由条目

  - 它不能及时适应网络状态的变化，对于简单的小型网络，可以采用静态路由
  - 静态路由选择**简单、开销小**，但**不能及时适应网络状态（流量、拓扑等）的变化**

* **动态路由算法**（自适应路由算法)

  指路由器上的路由表项是通过**相互连接的路由器之间彼此交换信息**，然后按照一定的算法优化出来的，而这些路由信息会在一定时间间隙里不断更新，以适应不断变化的网络，随时获得最优的寻路效果。

  **特点**

  - 路由器通过路由选择协议**自动获取**路由信息

  - 动态路由选择**比较复杂、开销比较大**，但能较**好地适应网络状态的变化**

  - 动态路由选择适用于**大规模网络**

### 距离-向量路由算法（动态）

在距离-向量路由算法中，所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点。这种路由选择表包含：

* 每条路径的目的地（另一结点)

* 路径的代价（距离）

  > 注意：这里的代价是一个抽象的概念，如`RIP`就将距离定义为“跳数”。跳数指从源端口到达目的端口所经过的路由器个数，每经过一个路由器，跳数加1

在这种算法中，**所有结点都必须参与距离向量交换**，以保证路由的有效性和一致性，也就是说，所有的结点都监听从其他结点传来的路由选择更新信息，并在下列情况下更新它们的路由选择表

### 链路状态路由算法（动态）

链路状态路由算法要求每个参与该算法的结点都具有完全的网络拓扑信息，典型的链路状态算法是 OSPF 算法。

在一个链路状态路由选择中，一个结点检查所有直接链路的状态，并将所得的状态信息发送给网上的所有其他结点，而不是仅送给那些直接相连的结点。每个结点都用这种方式从网上所有其他的结点接收包含直接链路状态的路由选择信息。

每当链路状态报文到达时，路由结点便使用这些状态信息去更新自己的网络拓扑和状态“视野图”，一旦链路状态发生变化,结点就对更新的网络图利用 Dijkstra 最短路径算法重新计算路由，从单一的源出发计算到达所有目的结点的最短路径。

链路状态路由算法主要特征：

* 向本自治系统中所有路由器发送信息，这里使用的方法是==洪泛法==，即路由器通过所有端口向所有相邻的路由器发送信息。

**应用**

由于一个路由器的链路状态只涉及相邻路由器的连通状态，而与整个互联网的规模并无直接关系，因此**链路状态路由算法可以用于大型的或路由信息变化聚敛的互联网环境**。

**优点**

链路状态路由算法的主要优点是，每个路由结点都使用同样的原始状态数据独立地计算路径，而不依赖中间节点的计算。即链路状态不加以改变地传播，易于查找故障

链路状态报文仅运载来自单个结点关于直连链路地信息，其大小与网络中路由结点数目无关，因此链路状态算法比距离-向量算法有更好的规模和可伸展性

## 路由选择协议

### 路由选择分类

1. 静态路由选择
2. 动态路由选择

![image-20231112205856663](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205856663.png)

+ **自适应**：**动态路由**选择，能较好地适应网络状态的变化

+ **分布式**：**各路由器**通过相互间的信息交互，**共同完成路由信息的获取和更新**

+ **分层次**：将整个因特网划分为许多较小的**自治系统**`AS（Autonomous System）`

  在自治系统内部和外部采用不同类别的路由选择协议，分别进行路由选择

![image-20231112205907287](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205907287.png)

**注意：**

1. 外部网关协议`EGP`和内部网关协议`IGP`只是路由选择协议的分类名称，而不是具体的路由选择协议
2. 外部网关协议和内部网关协议名称中使用的是“网关”这个名词，是因为在因特网早期的RFC文档中，没有使用“路由器”而使用的是“网关”这一名词

**因特网所采用的的路由选择协议主要特点**

+ **自适应**：动态路由选择，能较好地适应网络状态的变化
+ **分布式**：路由器之间交换路由信息
+ **分层次**：将整个因特网划分为许多较小的自治系统`AS（Autonomous System）`
+ 在自治系统内部和外部采用不同类别的路由选择协议，分别进行路由选择。

![image-20231112204603683](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204603683.png)

**注意：**

1. 外部网关协议`EGP`和内部网关协议`IGP`只是路由选择协议的分类名称，而不是具体的路由选择协议
2. 外部网关协议和内部网关协议名称中使用的是“网关”这个名词，是因为在因特网早期的RFC文档中，没有使用“路由器”而使用的是“网关”这一名词

### 路由信息协议`RIP` ###

`RIP(Routing Information Protocol，RIP)`

> `RIP`要求自治系统`AS`内的每一个路由器，都要维护从它自己到`AS`内其他每一个网络的距离记录。这是一组距离，称为**距离向量**`（Distance-Vector，D-V）`
>
> `RIP`使用**跳数**`(Hop Count)`作为度量(Metric)**来衡量到达目的网络的距离**
>
> + 路由器到**直连网络**的距离定义为`1`
>
> + 路由器到**非直连网络**的距离定义为所经过的路由器数`+1`
>
> + 允许一条路径最多只能包含`15`个路由器。**距离等于16时相当于不可达**。因此，**`RIP`只适用于小型互联网**
>
>   ![image-20231112204647738](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204647738.png)
>
> + `RIP`认为**好的路由**就是**距离短**的路由，也就是所**通过路由器数量最少的路由**
>
>   ![image-20231112204723520](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204723520.png)
>
> + 当到达同一目的网络有**多条距离相等**的路由时，可以进行**等价负载均衡**，也就是将通信量均衡地分布到多条等价的路径上

+ `RIP`包含以下三个要点

  1. 和谁交换信息

     > 仅和**相邻路由器**交换信息

  2. 交换什么信息

     > 交换的是**各自路由表的信息**

  3. 何时交换信息1

  4. ；

     > **周期性交换**
     >
     > 为了加快RIP的收敛速度，当网络拓扑发生变化时，路由器要及时向相邻路由器通告拓扑变化后的路由信息，这称为**触发更新**


#### `RIP`**的基本工作过程**

❶  路由器刚开始工作时，只知道自己到**直连网络**的`RIP`距离为`1`

![image-20231112204803684](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204803684.png)



❷  每个路由器**仅和相邻路由器周期性地交换并更新路由信息** 

❸  若干次交换和更新后，每个路由器都知道到达本自治系统`AS`内各网络的最短距离和下一跳路由器，称为**收敛**

![image-20231112204820256](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204820256.png)

#### `RIP`的距离向量算法

**假设D要更新自己的路由表**

1. C向D发送封装有路由信息的`RIP`更新报文

2. D收到C的路由表后，对其进行修改![image-20231112204940811](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204940811.png)
   D作为C的相邻路由器，当然也就可以通过C来到达这些网络，只是比C到达这些网络的RIP距离大1

3. 根据修改后的C的路由表，更新D的路由表![image-20231112204956988](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112204956988.png)

   **更新时有以下情况：**

   1. 到达目的网络，**相同的下一跳，最新消息，要更新**

      `RIP`变大了也要更新，因为这是最新消息

      |                     | 目的网络 | RIP距离 | 下一跳 |
      | ------------------- | -------- | ------- | ------ |
      | C的路由表           | N2       | 5       | C      |
      | D的路由表（更新前） | N2       | 2       | C      |
      | D的路由表（更新后） | N2       | 5       | C      |

   2. **发现了新的网络**，要更新（添加）

      |                     | 目的网络 | RIP距离 | 下一跳 |
      | ------------------- | -------- | ------- | ------ |
      | C的路由表           | N3       | 9       | C      |
      | D的路由表（更新前） | null     | null    | null   |
      | D的路由表（更新后） | N3       | 9       | C      |

   3. 到达目的网络，**不同的下一跳，新路由优势，要更新**

      |                     | 目的网络 | RIP距离 | 下一跳 |
      | ------------------- | -------- | ------- | ------ |
      | C的路由表           | N6       | 5       | C      |
      | D的路由表（更新前） | N6       | 8       | F      |
      | D的路由表（更新后） | N6       | 5       | C      |

   4. 到达目的网络，**不同的下一跳，RIP距离相等，可以等价负载均衡**

      |                     | 目的网络 | RIP距离 | 下一跳 |
      | ------------------- | -------- | ------- | ------ |
      | C的路由表           | N8       | 4       | C      |
      | D的路由表（更新前） | N8       | 4       | E      |
      | D的路由表（更新后） | N8       | 4       | C，E   |

   **不更新的情况：**

   1. 到达目的网络，**不同的下一跳，新路由劣势，不更新**

      |                     | 目的网络 | RIP距离 | 下一跳 |
      | ------------------- | -------- | ------- | ------ |
      | C的路由表           | N9       | 6       | C      |
      | D的路由表（更新前） | N9       | 4       | F      |
      | D的路由表（不更新） | N9       | 6       | C      |

   **除了上述RIP路由条目更新规则，在RIP的距离向量算法中还包含以下一些时间参数：**

   * **路由器**每隔大约30秒向其所有相邻路由器发送路由更新报文。
   * 若`180秒（默认）`没有收到某条路由条目的更新报文，则把该路由条目标记为无效（即把RIP距离设置为16，表示不可达），若再过一段时间（如120秒），还没有收到该路由条目的更新报文，则将该路由条目从路由表中删除。

   #### `RIP`存在的问题(坏消息传播得慢)

   ![image-20231112205138954](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205138954.png)

> 存在"**坏消息传播很慢**"的问题，又称为**路由环路(两个路由器相互学习错误路由，造成循环)**或距离无穷计数问题，这是距离向量算法的一个固有问题

可以采取多种措施**减少**出现该问题的概率或减小该问题带来的危害

+ 限制最大路径距离为`15`(`16`表示不可达)

+ 当路由表发生变化时就立即发送更新报文(即"**触发更新**")，而不是周期性发送

+ 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口反方向传送(即**"水平分割""毒性反转"**)

  **注意：**
             使用上述措施仍无法彻底解决问题。因为在距离向量算法中，每个路由器都缺少到目的网络整个路径的完整信息，无法判断所选的路由是否出现了环路。

#### `RIP`版本和相关报文的封装

> 现在较新的`RIP`版本是1998年11月公布的`RIP2`[RFC 2453]，已经成为因特网标准协议。与RIP1相比，`RIP2`可以支持变长子网掩码和CIDR。另外，`RIP2`还提供**简单的鉴别**过程并**支持多播**
>
> `RIP`相关报文使用运输层的用户数据报协议**`UDP`进行封装**，使用的`UDP`端口号为`520`
>
> * 从**`RIP`报文封装**的角度看，`RIP`属于TCP/IP体系结构的**应用层**
> * 但`RIP`的**核心功能是路由选择**，这属于TCP/IP体系结构的**网际层**

#### `RIP`的优缺点

![image-20231112205248407](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205248407.png)

#### 例题

![image-20231112205304637](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205304637.png)

![image-20231112205312200](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205312200.png)

### 开放最短路径优先`OSPF` ###

`OSPF（Open Shortest Path First）`

克服了`RIP`的缺点

> 简单来说就是得到一个带权有向图，以当前路由器为起点，通过*Dijkstra*算法得到到达某个点的最短路径

+ `OSPF`是**基于链路状态**的，而不像`RIP`那样是基于距离向量的

+ `OSPF`采用基于链路状态并采用`SPF（Shortest Path First）`算法计算路由，从算法上保证了**不会产生路由环路**

+ `OSPF`**不限制网络规模，更新效率高，收敛速度快**

#### 基本概念

##### 链路状态`LS`

> 链路状态`Link State，LS`是指本路由器都和**哪些路由器相邻**，以及**相应链路的代价`cost`**

代价的意思是费用、距离、时延、带宽等

![image-20231112205353213](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205353213.png)

##### 邻居关系的建立和维护:`Hello`分组


+ `OSPF`相邻路由器之间通过交互`问候(Hello)分组`，建立和维护邻居关系

  + `Hello`分组封装在`IP`数据报中，发往`组播地址224.0.0.5`,`IP`数据报首部中的协议号字段的取值为`89`，表明IP数据报的数据载荷为`OSPF`分组

    ![](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205415726.png)

    **注意:**

    ​         `OSPF`分组直接使用网际层的`IP`数据报进行封装，而不像`RIP`报文需要使用运输层用户数据报协议`UDP`封装。从数据包按网络体系结构逐层封装的角度看，`OSPF`属于网际层协议，而`RIP`属于应用层协议（但其核心功能是路由选择，属于网际层）

  + `Hello`分组发送周期为`10`秒

  + `40`秒未收到来自邻居路由器的`Hello`分组，则认为该邻居路由器不可达

  + 每个路由器都会建立一张`邻居表`![image-20231112205426370](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205426370.png)

##### 链路状态通告:`LSA`


+ 使用`OSPF`的每个路由器都会产生链路状态通告`LSA(Link State Advertisement)`，包含以下内容

  + **直连网络**的链路状态信息
  + **邻居路由器**的链路状态信息

##### 链路状态更新分组:`LSU`


+ `LSA`被封装在**链路状态更新分组`LSU(Link State Update，LSU)`**中，**采用可靠的洪泛法(Flooding)发送**

  > 洪泛法的要点是路由器向自己**所有的邻居路由器**发送链路状态更新分组，收到该分组的各路由器又将该分组转发给自己所有的邻居路由器（但其上游路由器除外），以此类推
  >
  > 可靠是指收到链路状态更新分组后要发送确认，**收到重复的更新分组无需再次转发**，但要发送一次确认

##### 链路状态数据库`LSDB`


+ 使用`OSPF`的每个路由器都有一个**链路状态数据库`LSDB`**，用于存储`LSA`

+ 通过各路由器洪泛法发送封**装有自己`LSA`的`LSU`分组**，各路由器的`LSDB`最终达到一致

+ 使用`OSPF`的各路由器**基于`LSDB`进行最短路径优先SPF计算**，构建出各种到达其他各路由器的最短路径，即**构建各自的路由表**

  ![image-20231112205504029](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205504029.png)

##### `OSPF`五种分组 ####

1. **问候**(`Hello`)分组

   用来发现和维护邻居路由器的可达性

2. **数据库描述**(**D**atabase **D**escription)分组

   向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息

3. **链路状态请求信息**(**L**ink **S**tate **R**equest)分组

   向邻居路由器请求发送某些链路状态项目的详细信息

4. **链路状态更新**(**L**ink **S**tate **U**pdate)分组

   路由器使用这种分组将其链路状态进行洪泛发送，即用洪泛法对全网更新链路状态

5. **链路状态确认**(**L**ink **S**tate **A**cknowledgement)分组

   这是对链路状态更新分组的确认分组

#### `OSPF`基本工作过程 ####

![image-20231112205530510](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205530510.png)

+ 相邻路由器之间周期性发送**问候分组(Hello)**，以便建立和维护邻居关系
+ 建立邻居关系后，**给邻居路由器发送数据库描述分组(DD)**，也就是将自己链路状态数据库中的所有链路状态项目的摘要信息发送给邻居路由器
+ 收到数据库描述分组后，若发现自己缺少其中某些链路状态项目，则会发送**链路状态请求分组(LSR)**。
+ 对方收到链路状态请求分组后，则会将其所缺少的链路状态项目的详细信息封装在**链路状态更新分组(LSU)**中发送回去
+ 收到链路状态更新分组后，将这些信息添加到自己的链路状态数据库中

#### 多点接入网络中的`OSPF`路由器 

> 一条总线上有多台主机，则它们互为邻居，因此每个路由器都要向其他路由器发送问候分组和链路状态更新分组。为了减少所发送分组的数量，则需要用相应方法对邻居关系进行删减

`OSPF`采用选举**指定路由器DR**(`Designated Router`)和**备用的指定路由器BDR**(`Backup Designated Router`)的方法减少邻居数目

+ 所有的非`DR/BDR`只与`DR/BDR`建立邻居关系
+ 非`DR/BDR`之间通过`DR/BDR`交换信息
+ 当`DR`失效时由`BDR`顶上

![image-20231112205643366](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205643366.png)

#### `OSPF`划分区域

为了使OSPF协议能够**用于规模很大的网络**，OSPF**把一个自治系统AS再划分为若干个更小的范围**，称为**区域**（area）

![image-20231112205657189](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205657189.png)

* 自治系统边界路由器（AS Border Router，ASBR）：R6
* 主干路由器（Backbone Router，BBR）：R3、R4、R5、R6和R7
* 区域内路由器（Internal Router，IR）：区域1内的R1和R2，区域2内的R8，区域3内的R9
* 区域边界路由器（Area Border Router，ABR）：R3、R4和R7

#### 例题

![image-20231112205709135](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205709135.png)

### 边界网关协议BGP ###

边界网关协议`（Border Gateway Protocol，BGP）`属于外部网关协议`EGP`这个类别，用于**自治系统AS之间的路由选择协议**

![image-20231119173358395](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231119173358395.png)

+ 在不同自治系统内，度量路由的"代价"(距离，宽带，费用等)可能不同。因此，对于自治系统之间的路由选择，使用"代价"作为度量来寻找最佳路由是不行的
  + 比如`A`系统路由选择度量是距离，`B`系统是带宽……那么`A`到系统`E`的路由怎样走最好呢？由于没有统一度量，所以不能直接得到最佳路由
+ 自治系统之间的路由选择必须考虑相关策略(政治、经济、安全等)
  + 如中国的数据报尽量要绕开美国的自治系统

#### 工作原理 ####

+ 在配置BGP时，每个AS的管理员要选择至少一个路由器作为该AS的**BGP发言人**
+ 一般来说，两个BGP发言人都是通过一个共享网络连接在一起的，而**BGP发言人往往就是BGP边界路由器**
+ 使用`TCP`连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站**（neighbor）或**对等站**（peer）
+ BGP发言人除了运行BGP协议外，还必须运行自己所在AS所使用的内部网关协议`IGP`，例如`RIP`或`OSPF`
+ `BGP`发言人**交换网络可达性的信息**(要到达某个网络所要经过的一系列自治系统)
+ 当`BGP`发言人互相交换了网络可达性的信息后，各`BGP`发言人就根据所采用的策略从收到的路由信息中**找出到达各自治系统的较好路由**。也就是构造出树形结构(防环路)的自治系统连通图

![image-20231112205800060](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205800060.png)

#### BGP-4的4中报文 ####

1. **OPEN(打开)报文**：用来与相邻的另一个`BGP`发言人建立关系，使通信初始化
2. **UPDATE(更新)报文**：用来通告某一路由的信息，以及列出要撤销的多条路由
3. **KEEPALIVE(保活)报文**：用来周期性地证实邻站的连通性
4. **NOTIFICATION(通知)报文**：用来发送检测到的差错

![image-20231112205811018](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205811018.png)

#### 例题

![image-20231112205827554](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205827554.png)

![image-20231112205833846](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112205833846.png)

## IP多播(组播)

- **多播**（Multicast，也称为**组播**）是一种实现“一对多”通信的技术，与传统单播“一对一”通信相比，多播可以极大地**节省网络资源**

- 在**因特网**上进行的多播，称为**IP多播**

![image-20231112210729386](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210729386.png)

### `IP`多播地址和多播组

`IP`多播可分为以下两种

> 1. 只在**本局域网**上进行的**硬件多播**
> 2. 在**因特网**上进行的**多播**

+ 在`IPv4`中，`D`类地址被作为多播地址
+ 多播地址只能用作**目的地址**，而不能用作源地址
+ 用每一个D类地址来标识一个多播组，使用同一个IP多播地址接收IP多播数据报的所有主机就构成了一个多播组
  + **每个多播组的成员是可以随时变动的，**一台主机可以随时加入或离开多播组
  + **多播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个多播组**
+ 非多播组成员也可以向多播组发送IP多播数据报
+ 与IP数据报相同，IP多播数据报也是“**尽最大努力交付**”，不保证一定能够交付给多播组内的所有成员

![image-20231112210748100](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210748100.png)

IPv4多播地址又可分为**预留的多播地址**（**永久多播地址**）、全**球范围可用的多播地址**以及**本地管理的多播地址**[RFC 3330]

![image-20231112210758607](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210758607.png)

### 在局域网上进行硬件多播

- 由于`MAC`地址（也称为硬件地址）有`多播MAC地址`这种类型，因此只要把`IPv4多播地址`映射成`多播MAC地址`，即可将**IP多播数据报封装在局域网的MAC帧**中，而`MAC帧首部`中的`目的MAC地址`字段的值，就设置为由`IPv4`多播地址映射成的多播`MAC`地址。这样，可以很方便地利用硬件多播来实现局域网内的`IP`多播

- 当给某个多播组的成员主机配置其所属多播组的`IP`多播地址时，系统就会根据映射规则从该IP多播地址生成相应的局域网多播`MAC`地址

![image-20231112210811372](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210811372.png)

- 因特网号码指派管理局`IANA`，将自己从IEEE注册管理机构申请到的以太网`MAC`地址块中从`01-00-5E-00-00-00`到`01-00-5E-7F-FF-FF`的多播`MAC`地址，用于映射`IPv4`多播地址
  - 这些多播MAC地址的**左起前25个比特都是相同的**，**剩余23个比特可以任意变化**，因此共有$2^{23}$个

![image-20231112210830279](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210830279.png)

![image-20231112210845807](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210845807.png)

- 由于`IP`多播地址可变化的`28`比特的前`5`个比特无法映射到`MAC`多播地址，这会造成`IP`多播地址与多播`MAC`地址的映射关系并不是唯一的

![image-20231112210853172](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210853172.png)

**举例**

![image-20231112210859983](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210859983.png)

- 由于`IP`多播地址与多播`MAC`地址的映射关系不是唯一的，因此收到`IP`多播数据报的主机还要在**网际层利用软件进行过滤**，把不是主机要接收的`IP`多播数据报丢弃

![image-20231112210911622](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210911622.png)

### 在因特网上进行`IP`多播需要两种协议

> 要在因特网上进行`IP`多播，就必须要考虑**`IP`多播数据报经过多个多播路由器进行转发**的问题
>
> - 多播路由器必须根据IP多播数据报首部中的IP多播地址，将其转发到有该多播组成员的局域网
>
> ![image-20231112210928054](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210928054.png)

#### 网际组管理协议`IGMP`

> - 网际组管理协议`（Internet Group Management Protocol，IGMP）`是`TCP/IP`体系结构网际层中的协议，其作用是让连接在本地局域网上的多播路由器知道本局域网上**是否有主机**（实际上是主机中的某个进程）**加入或退出了某个多播组**
>
> - `IGMP`**仅在本网络有效**，使用`IGMP`并不能知道多播组所包含的成员数量，也不能知道多播组的成员都分布在哪些网络中

**分类**

1. 成员报告报文
2. 成员查询报文
3. 离开组报文

**`IGMP`报文被封装在`IP`数据报中传送**

![image-20231112210942627](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210942627.png)

##### 基本工作原理

1. **加入多播组**

![image-20231112210956020](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112210956020.png)

2. **监视多播组的成员变化**

- GMP成员查询报文的内容**也可以是0.0.0.0，表示全部多播组**
- P多播数据报的目的地址：224.0.0.1，**特殊的IP多播地址，在本网络中所有参加多播的主机和路由器的网际层都会接受该多播数据报**

![image-20231124180359033](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124180359033.png)

![](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124181326196.png)

![](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124181256119.png)

- 同一网络中的多播路由器可能不止一个，但没有必要每个多播路由器都周期性地发送`IGMP`成员查询报文

- 只要在这些多播路由器中选择一个作为**查询路由器**，由查询路由器发送`IGMP`成员查询报文，而其他的多播路由器仅被动接收响应并更新自己的多播组列表即可
- **选择查询路由器的方法**：
  - 每个多播路由器若监听到源IP地址比自己的IP地址小的`IGMP`成员查询报文则退出选举
  - 最后，网络中只有**`IP`地址最小的多播路由器成为查询路由器**。

3. **退出多播组**

![image-20231112211037069](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211037069.png)

####  多播路由选择协议

多播路由选择协议的主要任务是：**在多播路由器之间为每个多播组建立一个多播转发树**

* 多播转发树连接多播源和所有拥有该多播组成员的路由器
* **IP多播数据报只要沿着多播转发树进行洪泛**，就能被传送到所有拥有该多播组成员的多播路由器
* 之后，**在多播路由器所直连的局域网内**，多播路由器通过**硬件多播**，将IP多播数据报发送给该多播组的所有成员
* 针对**不同的多播组需要维护不同的多播转发树**，而且必须**动态地适应多播组成员的变化**，但此时网络拓扑并不一定发生变化，因此**多播路由选择协议要比单播路由选择协议（例如RIP、OSPF等）复杂得多**
* 即使某个主机**不是任何多播组的成员**，它**也可以向任何多播组发送多播数据报**
* 为了覆盖多播组的所有成员，**多播转发树可能要经过一些没有多播组成员的路由器**

![image-20231124182653120](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124182653120.png)

##### 基于**源树**`（Source-Base Tree）`多播路由选择

> - 基于源树的多播路由选择的最典型算法是**反向路径多播**`（Reverse Path Multicasting，RPM）`算法
>
> - `RPM`算法包含以下两个步骤:
>   1. 利用**反向路径广播**`（Reverse Path Broadcasting，RPB）`算法建立一个广播转发树。
>   2. 利用**剪枝**`（Pruning）`算法，剪除广播转发树中的下游非成员路由器，获得一个多播转发树

* 要建立广播转发树，可以使用**洪泛（Flooding）法**

![image-20231112211102372](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211102372.png)

> - 利用**反向路径广播`RPB`**算法生成的广播转发树，**不会存在环路**，因此可以避免广播分组在环路中兜圈
>
> - RPB算法的要点是：每一台路由器在收到一个广播分组时，先检查该广播分组是否是从**源点经最短路径**传送来的
>   - 若是，本路由器就从自己除刚才接收该广播分组的接口的所有其他接口转发该广播分组
>   - 否则，丢弃该广播分组
>   - 如果本路由器有好几个邻居路由器都处在到源点的最短路径上，也就是**存在好几条同样长度的最短路径**，那么只能选取一条最短路径。选取的规则是这几条最短路径中的邻**居路由器的IP地址最小的那条最短路径**
>
> - RPB中“反向路径”的意思是：**在计算最短路径时把源点当作终点**

![image-20231112211121458](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211121458.png)

![image-20231112211129070](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211129070.png)

![image-20231112211135161](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211135161.png)

![image-20231112211144728](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211144728.png)

##### 组**共享树**`（Group-Shared Tree）`多播路由选择

- 组共享树多播路由选择采用**基于核心的分布式生成树算法**来建立共享树
  - 该方法在每个多播组中指定一个**核心**（core）路由器，以该路由器为**根**，建立一棵**连接多播组的所有成员路由器的生成树**，作为多播转发树
- 每个多播组中除了核心路由器，其他所有成员路由器都会向自己多播组中的核心路由器**单播加入报文**
  - 加入报文通过单播朝着核心路由器转发，**直到它到达已经属于该多播生成树的某个节点或者直接到达该核心路由器**
  - 加入报文所经过的路径，就确定了一条**从单播该报文的边缘节点到核心路由器之间的分支**，而这个新分支就被**嫁接到现有的多播转发树上**

![image-20231112211155864](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211155864.png)

![image-20231112211201299](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211201299.png)

## 虚拟专用网VPN ##

> **利用公用的因特网**作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网`（Virtual Private Network，VPN）`
>
> 虚拟专用网中各主机所分配的地址应该是本机构可自由分配的**专用地址**（`Private Address`），不需要向因特网的管理机构申请
>
> 出于安全考虑，专用网内的各主机并不应该直接“暴露”于公用的因特网上。因此，给专用网内各主机配置的IP地址应使各主机在专用网内可以相互通信，而不能直接与公用的因特网通信

**[RFC 1918]规定了以下三个CIDR地址块中的地址作为专用地址：**

![image-20231112211235490](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211235490.png)

很显然，全世界可能有很多不同机构的专用网具有相同的专用IP地址，但这并不会引起麻烦，因为这些专用地址仅在机构内部使用

在因特网中的所有路由器，对目的地址是专用地址的IP数据报一律不进行转发，这需要由因特网服务提供者ISP对其拥有的因特网路由器进行设置来实现

![image-20231112211246156](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211246156.png)

## 网络地址转换NAT

网络地址转换（Network Address Translation，NAT）技术于1994年被提出，用来缓解IPv4地址空间即将耗尽的问题

- NAT能**使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源**
- 需要在专用网络连接到因特网的路由器上**安装NAT软件**
- 装有NAT软件的路由器称为**NAT路由器**，它**至少要有一个有效的外部全球地址$IP_G$**
- 使用内部专用地址的主机在和外部因特网通信时，都要**在NAT路由器上将其内部专用地址转换成$IP_G$**

![image-20231121093412072](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231121093412072.png)

![image-20231121093441218](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231121093441218.png)

- 为了**更加有效地利用NAT路由器中的全球IP地址**，常将**NAT转换和运输层端口号结合使用**，称为**网络地址与端口号转换**
  - 使内部专用网中使用**专用地址的大量主机**，**共用NAT路由器上的1个全球IP地址**，因而可以同时与因特网中的不同主机进行通信

![image-20231121093838556](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231121093838556.png)

![image-20231121093915062](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231121093915062.png)

- NAT(和NAPT)对网络应用并不完全透明
- **通信必须有专用网内部发起，因此拥有内部专用地址的主机不能直接充当因特网中的服务器**

![image-20231121094213681](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231121094213681.png)



## 移动IP

![image-20231112211305404](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211305404.png)

> - 移动`IP（Mobile IP）`是因特网工程任务组IETF开发的一种技术[RFC 3344]，该技术使得**移动主机在各网络之间漫游时，仍然能够保持其原来的`IP`地址不变**
>
> - 移动IP技术还为因特网中的非移动主机提供了相应机制，使得它们能够将IP数据报正确发送到移动主机

### 基本概念

**归属网络**

> 每个移动主机都有一个**默认连接的网络或初始申请接入的网络**，称为归属网络`（Home Network）`

**归属地址**

> 移动主机在**归属网络中的`IP`地址在其整个移动通信过程中是始终不变的**，因此称为永久地址`（Permanent Address）`或归属地址`（Home Address）`

**归属代理**

> 在归属网络中，**代表移动主机执行移动管理功能的实体**称为归属代理`（Home Agent）`。**归属代理通常就是连接在归属网络上的路由器**，然而它作为代理的特定功能则是在网络层完成的

**外地网络**

> 移动主机**当前漫游所在的网络**称为外地网络`（Foreign Network）`或被访网络（Visited Network）

**外地代理**

> 在外地网络中，**帮助移动主机执行移动管理功能的实体**称为外地代理`（Foreign Agent）`

**转交地址**

> 外地代理通常就是连接在外地网络上的路由器。外地代理会为移动主机提供一个**临时使用的属于外地网络的转交地址**`（Care-of Address）`

### 基本工作原理

1. **代理发现与注册**

   - 移动主机A通过自己的**代理发现协议**，与外地代理建立联系，并从外地代理**获得一个属于该外地网络的转交地址**（例如175.1.1.1/16），同时**向外地代理注册自己的永久地址和归属代理地址**
   - 外地代理将移动主机A的永久地址记录在自己的注册表中，并**向移动主机的归属代理注册该移动主机的转交地址**（也可由移动主机直接进行注册）
   - 归属代理会将移动主机A的转交地址记录下来，此后**归属代理会代替移动主机接收**所有发送给该移动主机的IP数据报，并**利用IP隧道技术**将这些数据报**转发给外地网络中的移动主机**
   - **当移动主机不在归属网络时**，归属代理会以自己的MAC地址应答所有对该移动主机的ARP请求，即**归属代理采用ARP代理技术**
   - 为了使归属网络中其他各主机和路由器能够尽快更新各自的ARP高速缓存，**归属代理还会主动发送ARP广播**，**并声称自己是该移动主机**。这样，所有发送给该移动主机的IP数据报都会发送给归属代理

   ![image-20231124185143546](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124185143546.png)

2. **固定主机向移动主机发送IP数据报**

![image-20231124185233626](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124185233626.png)

![image-20231124185340717](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124185340717.png)

- **当外地代理和移动主机不是同一台设备时，转交地址实际上是外地代理的地址而不是移动主机的地址**，转交地址既不会作为移动主机发送IP数据报的源地址，也不会作为移动主机所接收的IP数据报的目的地址
- **转交地址仅仅是归属代理到外地代理的IP隧道的出口地址**
- 所有使用同一外地代理的移动主机都可以**共享同一个转交地址**

3. **移动主机向固定主机发送IP数据报**

![image-20231124185608452](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124185608452.png)

-  由于IP路由器并不关心IP数据报的源地址，因此该IP数据报被直接路由到固定主机B，而**无须再通过归属代理进行转发**
- 移动主机可以将**外地代理**作为自己的**默认路由器**，也可以通过代理发现协议从外地代理**获取外地网络中其他路由器**的地址，并将其设置为自己的**默认路由器**

4. **同址转交地址方式**
   - **移动主机需要运行额外的外地代理软件**
   - 外地网络也需要提供相应机制，使移动主机能够自动获取一个外地网络中的地址作为自己的IP地址和外地代理的地址，被称为**同址转交地址**（Co-Located Care-of Address）
5. **三角形路由问题**

![image-20231124190046553](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231124190046553.png)

> 解决三角形路由问题的一种方法：
>
> - 给固定主机配置一个**通信代理**，固定主机发送给移动主机的IP数据报，都要通过该**通信代理转发**
> - 通信代理先从归属代理获取移动主机的转交地址，之后所有发送给移动主机的IP数据报，都利用转交地址直接通过IP隧道发送给移动主机的外地代理，而无须再通过移动主机的归属代理进行转发
> - 这种方法以增加复杂性为代价，并要求固定主机也要配置通信代理，也就是对固定主机不再透明。

##  路由器的基本工作原理 

路由器是一种具有多个输入端口和输出端口的**专用计算机**，其任务是**转发分组**

实现交换结构的三种基本方式是：通过存储器、通过总线以及通过互连网络。这三种交换结构可实现的路由器转发速率依次提高。

![image-20231112211404371](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211404371.png)

![image-20231112211414028](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/image-20231112211414028.png)